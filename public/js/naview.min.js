class NaView{constructor({svg_id:e="naview_svg",container_id:t="naview_container",svg_width:r=1200,svg_height:i=500,style_obj_input:a,protein_input:n,properties:o={},color_rules:s=[],text_to_draw:l=[],relationships:_=[]}={}){this.svg_id=e,this.container_id=t,this.svg_width=r,this.svg_height=i,this.style_obj_input=a,this.protein_input=n,this.properties=o,this.color_rules=s,this.text_to_draw=l,this.relationships=_,this.scrollX=0,this.scrollY=0,this.bbox,this.one_to_three={A:"ALA",C:"CYS",D:"ASP",E:"GLU",F:"PHE",G:"GLY",H:"HIS",I:"ILE",K:"LYS",L:"LEU",M:"MET",N:"ASN",P:"PRO",Q:"GLN",R:"ARG",S:"SER",T:"THR",V:"VAL",W:"TRP",Y:"TYR"},this.three_to_one={ALA:"A",CYS:"C",ASP:"D",GLU:"E",PHE:"F",GLY:"G",HIS:"H",ILE:"I",LYS:"K",LEU:"L",MET:"M",ASN:"N",PRO:"P",GLN:"Q",ARG:"R",SER:"S",THR:"T",VAL:"V",TRP:"W",TYR:"Y"},this.allowed_element_names=["DomainI;Helix1","DomainI;Helix2","DomainI;Helix3","DomainI;Helix4","DomainI;Helix5","DomainI;Helix6","DomainII;Helix1","DomainII;Helix2","DomainII;Helix3","DomainII;Helix4","DomainII;Helix5","DomainII;Helix6","DomainIII;Helix1","DomainIII;Helix2","DomainIII;Helix3","DomainIII;Helix4","DomainIII;Helix5","DomainIII;Helix6","DomainIV;Helix1","DomainIV;Helix2","DomainIV;Helix3","DomainIV;Helix4","DomainIV;Helix5","DomainIV;Helix6","DomainI;Loop1","DomainI;Loop2","DomainI;Loop3","DomainI;Loop4","DomainI;Loop5","DomainI;Loop6","DomainII;Loop1","DomainII;Loop2","DomainII;Loop3","DomainII;Loop4","DomainII;Loop5","DomainII;Loop6","DomainIII;Loop1","DomainIII;Loop2","DomainIII;Loop3","DomainIII;Loop4","DomainIII;Loop5","DomainIII;Loop6","DomainIV;Loop1","DomainIV;Loop2","DomainIV;Loop3","DomainIV;Loop4","DomainIV;Loop5","DomainIV;Loop6","DomainI;Pore","DomainII;Pore","DomainIII;Pore","DomainIV;Pore","InterDomain1;Loop","InterDomain2;Loop","InterDomain3;Loop","InterDomain4;Loop","InterDomain5;Loop"],this.fillRules=[],this.svg_drawarea,this.initiated=!1,this.initLib()}getSvgId(){return this.svg_id}generateDefaultStyleObject(){return{membrane:{membrane_mode:"lipid",membrane_draw_opts:{hfill:"white",hstroke:"black",hstroke_s:2,hopacity:.6,tfill:"black",tstroke:"black",tstroke_s:2,topacity:.6,lipid_head_radius_width:.0075,lipid_head_radius_height:.1,lipid_tail_number:2,lipid_tail_breaks:1,lipid_tail_spacing:.001},membrane_region_height:.4},protein:{helix_mode:"cartoon",helix_draw_opts:{x_to_end_prop:.05,y_to_mid_prop:1/7,aa_area_perc_displacement:.1,thickness:.55,front_helix_stroke:"black",back_helix_stroke:"black",hh_stroke_size:1.5,type:"dicts",fill:{type:"domain_and_name",I:{1:"red",2:"red",3:"red",4:"blue",5:"red",6:"red"},II:{1:"red",2:"red",3:"red",4:"blue",5:"red",6:"red"},III:{1:"red",2:"red",3:"red",4:"blue",5:"red",6:"red"},IV:{1:"red",2:"red",3:"red",4:"blue",5:"red",6:"red"}},back_fill:{type:"domain_and_name",I:{1:"salmon",2:"salmon",3:"salmon",4:"lightblue",5:"salmon",6:"salmon"},II:{1:"salmon",2:"salmon",3:"salmon",4:"lightblue",5:"salmon",6:"salmon"},III:{1:"salmon",2:"salmon",3:"salmon",4:"lightblue",5:"salmon",6:"salmon"},IV:{1:"salmon",2:"salmon",3:"salmon",4:"lightblue",5:"salmon",6:"salmon"}},stroke:{type:"domain_and_name",I:{1:"red",2:"red",3:"red",4:"blue",5:"red",6:"red"},II:{1:"red",2:"red",3:"red",4:"blue",5:"red",6:"red"},III:{1:"red",2:"red",3:"red",4:"blue",5:"red",6:"red"},IV:{1:"red",2:"red",3:"red",4:"blue",5:"red",6:"red"}},stroke_size:{type:"domain_and_name",I:{1:2,2:2,3:2,4:3,5:2,6:2},II:{1:2,2:2,3:2,4:3,5:2,6:2},III:{1:2,2:2,3:2,4:3,5:2,6:2},IV:{1:2,2:2,3:2,4:3,5:2,6:2}},opacity:{type:"domain_and_name",I:{1:1,2:1,3:1,4:1,5:1,6:1},II:{1:1,2:1,3:1,4:1,5:1,6:1},III:{1:1,2:1,3:1,4:1,5:1,6:1},IV:{1:1,2:1,3:1,4:1,5:1,6:1}}},helix_region_width:{type:"domain_and_name",I:[.02,.02,.02,.02,.02,.02],II:[.02,.02,.02,.02,.02,.02],III:[.02,.02,.02,.02,.02,.02],IV:[.02,.02,.02,.02,.02,.02]},helix_region_height:{I:[.4,.4,.4,.4,.4,.4],II:[.4,.4,.4,.4,.4,.4],III:[.4,.4,.4,.4,.4,.4],IV:[.4,.4,.4,.4,.4,.4]},helix_spacing_width:{I:[5,5,5,5,5,5],II:[5,5,5,5,5,5],III:[5,5,5,5,5,5],IV:[5,5,5,5,5,5]},short_loops_draw_opts:{type:"single",stroke:"black",fill:"none",opacity:1,stroke_size:"3px",calc_len:{type:"reslen",calc:{length:2}},shape:{type:"simple",calc:{y_step:.5}}},pore_loops_draw_opts:{type:"single",stroke:"black",fill:"none",opacity:1,stroke_size:"3px",calc_len:{type:"reslen",calc:{length:2}},shape:{type:"simple_skewed",calc:{perc_center_x:0,y_step:.5}}},pore_region_width:{I:.01,II:.01,III:.01,IV:.01},pore_region_height:{I:.4,II:.4,III:.4,IV:.4},long_loops_draw_opts:{type:"single",stroke:"black",fill:"none",opacity:1,stroke_size:"3px",width:{type:"scaled"},calc_len:{type:"reslen",calc:{length:2}},shape:{type:"mushroom",calc:{x_step:.5,y_step:1,perc_center_x:.9,perc_step_y1:.1,perc_step_y2:.5}}},nter_loop_width:.05,nter_loop_draw_opts:{type:"single",stroke:"black",fill:"none",opacity:1,stroke_size:"3px",calc_len:{type:"reslen",calc:{length:2,start_loop:"edge"}},shape:{type:"n_curves",calc:{y_step:.5,perc_centers_height:[1,.5],loop_rotation:30}}},cter_loop_width:.05,cter_loop_draw_opts:{type:"single",stroke:"black",fill:"none",opacity:1,stroke_size:"3px",calc_len:{type:"fixed",calc:{height:.4,start_loop:"edge"}},shape:{type:"n_curves",calc:{y_step:.5,perc_centers_height:[1,.8,.5,.4],loop_rotation:-30}}},residue_centroid_draw_opts:{type:"single",stroke:"black",fill:"red",opacity:1,stroke_size:"0px",circle_radius:"1.5px"},residue_relations_draw_opts:{type:"single",opacity:1,stroke_size:"1.5px",centroid_pos:{type:"fixed",perc_y:"between",perc_x:"between",perc_dict:{intramembrane:{intramembrane:{perc_y1:"between",perc_x1:"between"},intracellular:{perc_y1:.65,perc_x1:"between"},extracellular:{perc_y1:.35,perc_x1:"between"}},intracellular:{intracellular:{perc_y1:"between",perc_x1:"between"},intramembrane:{perc_y1:.65,perc_x1:"between"},extracellular:{perc_y1:.85,perc_x1:.95}},extracellular:{extracellular:{perc_y1:"between",perc_x1:"between"},intracellular:{perc_y1:.15,perc_x1:.05},intramembrane:{perc_y1:.35,perc_x1:"between"}}}},weight_scaling:"absolute",path_width_scaling:{type:"calc",perc_x:.01,domain:["min","max"],range:[2,5],group_by_type:!0},color_scaling:{type:"none",property:"weight",domain:["min","max"],range:["green","blue"],lighter_fill:!0},element_centroid_scaling:{type:"fixed",radius:5},stroke:"green",fill:"lightgreen"}},canvas:{border:{right:.02,left:.02,top:.02,bottom:.02}},text_defs:{font_family:"sans-serif",font_style:"italic",font_size:"30px",fill:"black",center_xy:!0}}}getStyleObject(e){if(e){if("var"===e)return this.style_obj;if("json"===e)return JSON.stringify(this.style_obj)}return this.style_obj}getParsedProteinData(){return this.parsed_protein_data.data}getAllResids(){return this.rangeArray(this.parsed_protein_data.fullseq.length,1)}getOneToThree(){return this.one_to_three}getThreeToOne(){return this.three_to_one}getElementNamesCentroids(){return this.parsed_protein_data.residue_element_centroids}setCurrentPropertiesResetView(e){this.properties=e,this.resetLib()}setCurrentRelationsResetView(e){this.relationships=e,this.resetLib()}getCurrentProperties(){return this.properties}setStyleObj(e){this.style_obj=this.deepCopy(e)}setStyleObjResetView(e){console.log("new_style_obj"),console.log(e),this.style_obj=this.deepCopy(e),this.resetLib()}getTextRules(){return this.text_to_draw=this.deepCopy(this.parsed_protein_data.draw_symbols),this.deepCopy(this.text_to_draw)}getColorRules(){return this.color_rules}setTextRulesAndReRender(e){let t=this;d3.selectAll(".text_symbol_borders").style("visibility","hidden"),d3.selectAll(".text_symbol_borders").datum(function(e,r){let i=t.deepCopy(e);return i.clicked=!1,i});let r=d3.select("#naview_text_editor_div");r.size()>0&&r.remove(),this.text_to_draw=this.deepCopy(e),this.resetLib()}setColorRulesAndReRender(e){this.color_rules=this.deepCopy(e),this.resetLib()}initLib(){if(this.initMainSvg(this.svg_id,this.container_id,this.svg_width,this.svg_height),this.style_obj_input&&(this.style_obj=this.style_obj_input),this.style_obj||(console.warn("style obj not set. creating a new one..."),this.style_obj=this.generateDefaultStyleObject()),!this.protein_input)throw"Error: no protein input data";this.initData(),this.initViz()}resetLib(){d3.select("#"+this.svg_id).html(""),this.initViz()}initMainSvg(e,t,r,i){let a;t?0===(a=d3.select("#"+t)).size()&&(a=d3.select("body").append("div").attr("id",t)):a=d3.select("body");let n=d3.select("#"+e);0===n.size()?n=a.append("svg").attr("id",e).attr("width",r).attr("height",i):n.attr("width",r).attr("height",i),!1===this.initiated&&(console.log("init"),this.scrollX=document.documentElement.scrollWidth-document.documentElement.clientWidth,this.scrollY=document.documentElement.scrollHeight-document.documentElement.clientHeight,this.bbox=n.node().getBoundingClientRect(),console.log("this.bbox"),console.log(this.deepCopy(this.bbox)),this.initiated=!0)}initData(){let e=!0,t=["fullseq","data","count_data","resid_properties"];for(let r=0;r<t.length;r++){let i=t[r];if(!1===this.protein_input.hasOwnProperty(i)){console.warn("input data is missing required data keys... trying to parse raw data"),e=!1;break}}this.parsed_protein_data=e?this.protein_input:this.processRawUniProt(this.protein_input)}initViz(){this.parsed_protein_data_drawareas=this.define_draw_areas(this.parsed_protein_data.data),this.parsed_protein_data.data=this.parsed_protein_data_drawareas[0],console.log("this.parsed_protein_data.data"),console.log(this.parsed_protein_data.data),this.parsed_protein_data.membrane=this.parsed_protein_data_drawareas[1],this.parsed_protein_data.draw_area=this.parsed_protein_data_drawareas[2],this.parsed_protein_data.resid_properties=this.properties,this.parsed_protein_data.color_rules=this.color_rules,this.parsed_protein_data.draw_symbols=this.text_to_draw,this.parsed_protein_data.residue_relations=this.relationships,this.drawEverything(this.parsed_protein_data),console.log("generated plot!")}roundDecimals(e,t){let r=Math.pow(10,t);return Math.round(e*r+Number.EPSILON)/r}getRandomIntInclusive(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e}getRandomFloatInclusive(e,t){return Math.random()*(t-e)+e}stringToChunks(e,t){var r,i,a=[];for(r=0,i=e.length;r<i;r+=t)a.push(e.substr(r,t));return a}stringToChunksSkip(e,t,r){var i=[];let a=!1,n=0,o="";for(let s=0,l=e.length;s<l;s++)o+=e[s],n+=1,!1===a?n===t&&(i.push(o),o="",n=0,a=!0):n===r&&(i.push(o),o="",n=0,a=!1);return o.length>0&&i.push(o),i}rangeArray(e,t=0){return[...Array(e).keys()].map(e=>e+t)}deepCopy(e){return JSON.parse(JSON.stringify(e))}colorToRGBA(e){var t,r;return(t=document.createElement("canvas")).height=1,t.width=1,(r=t.getContext("2d")).fillStyle=e,r.fillRect(0,0,1,1),r.getImageData(0,0,1,1).data}colorToRGB(e){var t,r;(t=document.createElement("canvas")).height=1,t.width=1,(r=t.getContext("2d")).fillStyle=e,r.fillRect(0,0,1,1);let i=(r.getImageData(0,0,1,1).data+"").split(","),a=i.slice(0,i.length-1);a.join(",");return a}componentToHex(e){var t=(e=parseInt(e)).toString(16);return 1==t.length?"0"+t:t}rgbToHex(e,t,r){return"#"+this.componentToHex(e)+this.componentToHex(t)+this.componentToHex(r)}pSBC(e,t,r,i){let a,n,o,s,l,_,p,c=parseInt,d=Math.round,h="string"==typeof r;return"number"!=typeof e||e<-1||e>1||"string"!=typeof t||"r"!=t[0]&&"#"!=t[0]||r&&!h?null:(this.pSBCr||(this.pSBCr=(e=>{let t=e.length,r={};if(t>9){if([a,n,o,h]=e=e.split(","),(t=e.length)<3||t>4)return null;r.r=c("a"==a[3]?a.slice(5):a.slice(4)),r.g=c(n),r.b=c(o),r.a=h?parseFloat(h):-1}else{if(8==t||6==t||t<4)return null;t<6&&(e="#"+e[1]+e[1]+e[2]+e[2]+e[3]+e[3]+(t>4?e[4]+e[4]:"")),e=c(e.slice(1),16),9==t||5==t?(r.r=e>>24&255,r.g=e>>16&255,r.b=e>>8&255,r.a=d((255&e)/.255)/1e3):(r.r=e>>16,r.g=e>>8&255,r.b=255&e,r.a=-1)}return r})),p=t.length>9,p=h?r.length>9||"c"==r&&!p:p,l=this.pSBCr(t),s=e<0,_=r&&"c"!=r?this.pSBCr(r):s?{r:0,g:0,b:0,a:-1}:{r:255,g:255,b:255,a:-1},s=1-(e=s?-1*e:e),l&&_?(i?(a=d(s*l.r+e*_.r),n=d(s*l.g+e*_.g),o=d(s*l.b+e*_.b)):(a=d((s*l.r**2+e*_.r**2)**.5),n=d((s*l.g**2+e*_.g**2)**.5),o=d((s*l.b**2+e*_.b**2)**.5)),h=l.a,_=_.a,h=(l=h>=0||_>=0)?h<0?_:_<0?h:h*s+_*e:0,p?"rgb"+(l?"a(":"(")+a+","+n+","+o+(l?","+d(1e3*h)/1e3:"")+")":"#"+(4294967296+16777216*a+65536*n+256*o+(l?d(255*h):0)).toString(16).slice(1,l?void 0:-2)):null)}onlyUnique(e,t,r){return r.indexOf(e)===t}processRawUniProt(e){let t,r,i=e.split("\n"),a=!1,n=!1,o="",s={},l={"FT   TOPO_DOM":"loop","FT   INTRAMEM":"pore","FT   TRANSMEM":"helix"},_=[],p={},c={},d="";for(let e=0;e<i.length;e++){let h=i[e];if(h.length>13){let u=h.substr(0,13);if(!1===a&&!1===n){if("FT   CHAIN   "===u){t=parseInt(h.split("FT   CHAIN   ")[1].split("..")[0].replace(/\s+/,"")),r=parseInt(h.split("FT   CHAIN   ")[1].split("..")[1]),a=!0;continue}}else if(!0===a&&!1===n){if(Object.keys(l).indexOf(u)>-1){let t=[u,h],r=i[e+1];!0===r.includes("/note=")&&t.push(r),_.push(t)}if(o.includes(".."+r)){n=!0;continue}}if("FT   REPEAT  "===u){let t=i[e+1].split('/note="')[1].replace(/\"/,""),r=parseInt(h.split("FT   REPEAT  ")[1].split("..")[0].replace(/\s+/,"")),a=parseInt(h.split("FT   REPEAT  ")[1].split("..")[1]);s[t]=[r,a],p[t]=0,c[t]={},c[t].loop=0,c[t].helix=0,c[t].pore=0}if("SQ   SEQUENCE"===u){if(parseInt(h.split("SQ   SEQUENCE")[1].split(" AA;")[0].replace(/\s+/,""))!==r)return!1;d="";for(let t=e+1;t<i.length;t++)if(!1===i[t].includes("//")){d+=i[t].replace(/\s+/g,"")}}}o=h}let h=[],u=!1,m={loop:0,helix:0,pore:0},y=0,g={loop:0,helix:0,pore:0,internal_loop:0},f={loop:[],helix:[],pore:[],internal_loop:[]};for(let e=0;e<_.length;e++){let t=_[e],r=parseInt(t[1].split(t[0])[1].split("..")[0].replace(/\s+/,"")),i=parseInt(t[1].split(t[0])[1].split("..")[1]),a=l[t[0]],n=i-r+1;m[a]+=n,g[a]+=1,f[a].push(n),0===e||e===_.length-1?y+=n:"loop"===a&&(g.internal_loop+=1,f.internal_loop.push(n))}let w=r-y;m.internal_helix=m.helix,m.internal_loop=m.loop-y,m.internal_pore=m.pore;let x={loop:0,helix:0,pore:0,internal_loop:0},b={I:"II",II:"III",III:"IV"},v=1;for(let e=0;e<_.length;e++){let t=_[e],i=l[t[0]];x[i]+=1,e>0&&e<_.length-1&&"loop"===i&&(x.internal_loop+=1);let a=t[2].split('/note="')[1].split('"')[0],n=parseInt(t[1].split(t[0])[1].split("..")[0].replace(/\s+/,"")),o=parseInt(t[1].split(t[0])[1].split("..")[1]),y=d.split("").slice(n-1,o),g=!1;for(const e in s)if(s.hasOwnProperty(e)){let t=s[e];n>=t[0]&&n<=t[1]&&o>=t[0]&&o<=t[1]&&(g=e)}g&&(p[g]+=1,c[g][i]+=1);let f={type:i,start:n,end:o,aanum:o-n+1,aaperc_full:(o-n+1)/r,aaperc_bytype_full:(o-n+1)/m[i],aas:y.join(""),type_i_full:x[i],id:e+1,prev_dom_name:u,next_dom_name:b[u],note:a};g?(f.dom_name=g,f.dom_i=p[g],f.dom_itype=c[g][i],f.aaperc_alldomains=(o-n+1)/w,f.aaperc_bytype_alldomains=(o-n+1)/m["internal_"+i]):(f.dom_name=!1,f.dom_i=!1,f.dom_itype=!1,f.dom_iname=v,v+=1),h.push(f),u=g}let k={type:g,aacounts_per_type:f},I={};for(let e=0;e<d.length;e++)!1===I.hasOwnProperty(e+1)&&(I[e+1]={});return{fullseq:d,data:h,count_data:k,resid_properties:I}}define_draw_areas(e){e.reduce(function(e,t,r,i){return e+t.aaperc},0);let t=this.createDrawingArea(),r=this.drawDataParsing(e),i=this.calcDomIDomWidths(t,r.domain_names,r.helices_and_pores_by_domain),a=this.distributeLongLoopsWidth(i.inter_domain_width,r.long_loops),n=this.calcElementsDrawAreas(e,t,r.domain_names,r.helices_and_pores_by_domain,r.internal_short_loops_by_domain,r.long_loops_by_prevdomain,a,i.total_domain_width,i.inter_domain_width);for(let t=0;t<e.length;t++){let r=e[t].id;e[t].draw_area=n.protein[r]}return[e,n.membrane,t]}createDrawingArea(){let e=this.svg_width*this.style_obj.canvas.border.left,t=this.svg_width-(e+this.svg_width*this.style_obj.canvas.border.right),r=e+t,i=this.svg_height*this.style_obj.canvas.border.top,a=this.svg_height-(i+this.svg_height*this.style_obj.canvas.border.bottom),n=i+a,o=a/2-this.svg_height*this.style_obj.membrane.membrane_region_height/2,s=a/2+this.svg_height*this.style_obj.membrane.membrane_region_height/2,l=this.svg_height*this.style_obj.membrane.membrane_region_height;return this.svg_drawarea={start_x:e,end_x:r,width:t,start_y:i,end_y:n,height:a,membrane_start:o,membrane_height:l,membrane_end:s},this.svg_drawarea}drawDataParsing(e){let t=e.filter(function(e){return"helix"===e.type||"pore"===e.type}),r=t.reduce((e,t)=>(e[t.dom_name]=[...e[t.dom_name]||[],t],e),{}),i=e.filter(function(e){return"loop"===e.type&&!1!==e.dom_name}),a=i.reduce((e,t)=>(e[t.dom_name]=[...e[t.dom_name]||[],t],e),{}),n=e.filter(function(e){return"loop"===e.type&&!1!==e.prev_dom_name&&!1===e.dom_name&&e.next_dom_name}),o=n.reduce((e,t)=>(e[t.prev_dom_name]=t,e),{});return{helices_and_pores:t,helices_and_pores_by_domain:r,internal_short_loops:i,internal_short_loops_by_domain:a,long_loops:n,long_loops_by_prevdomain:o,domain_names:Object.keys(r)}}calcDomIDomWidths(e,t,r){let i=0,a={};for(let e=0;e<t.length;e++){let r=t[e],n=0;n+=this.style_obj.protein.helix_spacing_width[r].reduce(function(e,t){return e+t},0);let o=this.style_obj.protein.helix_region_width[r].reduce(function(e,t){return e+t},0);n+=this.svg_width*o,n+=this.svg_width*this.style_obj.protein.pore_region_width[r],a[r]=n,i+=n}let n=this.svg_width*this.style_obj.protein.nter_loop_width,o=this.svg_width*this.style_obj.protein.cter_loop_width;return{total_domain_width:i,inter_domain_width:e.width-(i+n+o),domain_to_width:a}}distributeLongLoopsWidth(e,t){let r;switch(this.style_obj.protein.long_loops_draw_opts.width.type){case"custom":r=function(e){return this.svg_width*calc_len[e]};break;case"scaled":let i=t.reduce(function(e,t){return e+t.aanum},0);r=d3.scaleLinear().range([0,e]).domain([0,i]);break;case"reslen":break;default:r=function(r){return e/t.length}}return r}calculateDrawAreaMembrane(e){let t=e.start_x,r=e.end_x,i=r-t,a=e.membrane_start,n=e.membrane_end;return{start_x:t,end_x:r,width:i,start_y:a,end_y:n,height:n-a}}calculateDrawAreaTermini(e,t,r,i,a){let n={objs:[],end_x:0},o=t.start_x,s=this.svg_width*this.style_obj.protein.nter_loop_width;"C"===e&&(o=t.start_x+s+(i+a),s=this.svg_width*this.style_obj.protein.cter_loop_width);let l=o+s,_=t.start_y,p=t.membrane_start;"Cytoplasmic"===r.note&&(_=t.membrane_end,p=t.end_y);let c={start_x:o,end_x:l,width:s,start_y:_,end_y:p,height:p-_};return r.draw_area=c,n.objs.push(r),n}calculateDrawAreaHelicesPoresByDomain(e,t,r,i){let a,n={objs:[],end_y:0,end_x:0},o=i,s=0,l=-1;for(let i=0;i<t.length;i++){let _=t[i],p=_.dom_name,c=o,d=r.membrane_start,h=0,u=0;p!==a&&(l=-1,a=p+""),l+=1,"pore"===_.type?(h=this.svg_width*this.style_obj.protein.pore_region_width[e],u=this.svg_height*this.style_obj.protein.pore_region_height[e]):(h=this.svg_width*this.style_obj.protein.helix_region_width[e][s],u=this.svg_height*this.style_obj.protein.helix_region_height[e][s],s+=1);let m={start_x:c,end_x:c+h,width:h,start_y:d,end_y:d+u,height:u};t[i].draw_area=m,n.objs.push(t[i]),n.end_y=d+u,o+=h;let y=this.style_obj.protein.helix_spacing_width[p][l];i<t.length-1&&(o+=y)}return n.end_x=o,n}indexDrawAreas(e,t){for(let r=0;r<t.length;r++){let i=t[r];e[i.id]=i.draw_area}return e}calculateDrawAreaShortLoopsByDomain(e,t,r,i){let a={objs:[],width:0,end_y:0};for(let i=0;i<e.length;i++){let n=e[i],o=t[i],s=t[i+1],l=o.draw_area.end_x-o.draw_area.width/2,_=s.draw_area.start_x+s.draw_area.width/2,p=_-l,c=r.start_y,d=r.membrane_start;"Cytoplasmic"===n.note&&(c=r.membrane_end,d=r.end_y);let h={start_x:l,end_x:_,width:p,start_y:c,end_y:d,height:d-c};e[i].draw_area=h,a.objs.push(e[i])}return a}calculateDrawAreaLongLoops(e,t,r,i,a){let n={objs:[],end_x:0},o=t,s=this.style_obj.protein.helix_region_width[e.prev_dom_name],l=this.svg_width*s[s.length-1]/2,_=this.style_obj.protein.helix_region_width[e.next_dom_name],p=this.svg_width*_[0]/2,c=o-l,d=e;"custom"!==this.style_obj.protein.long_loops_draw_opts.width.type&&(d=e.aanum);let h=i(d)+l+p,u=a.start_y,m=a.membrane_start;"Cytoplasmic"===e.note&&(u=a.membrane_end,m=a.end_y);let y=m-u,g={start_x:c,end_x:c+h,width:h,start_y:u,end_y:u+y,height:y};return e.draw_area=g,n.objs.push(e),o+=i(d),n.end_x=o,n}calcElementsDrawAreas(e,t,r,i,a,n,o,s,l){let _={protein:{},membrane:void 0},p=this.calculateDrawAreaMembrane(t);_.membrane=p;let c=t.start_x+this.svg_width*this.style_obj.protein.nter_loop_width,d=e[0],h=this.calculateDrawAreaTermini("N",t,d,s,l);_.protein[1]=h.objs[0].draw_area;let u=e[e.length-1],m=this.calculateDrawAreaTermini("C",t,u,s,l);_.protein[e.length]=m.objs[m.objs.length-1].draw_area;for(let e=0;e<r.length;e++){let s=r[e],l=this.calculateDrawAreaHelicesPoresByDomain(s,i[s],t,c);_.protein=this.indexDrawAreas(_.protein,l.objs);let p=this.calculateDrawAreaShortLoopsByDomain(a[s],l.objs,t,c);_.protein=this.indexDrawAreas(_.protein,p.objs),c=l.end_x;let d=l.end_y,h=n[s];if(h){let e=this.calculateDrawAreaLongLoops(h,c,d,o,t);_.protein=this.indexDrawAreas(_.protein,e.objs),c=e.end_x}}return _}drawEverything(e){let t=this.parsed_protein_data.membrane;for(const e in this.style_obj.membrane.membrane_draw_opts)this.style_obj.membrane.membrane_draw_opts.hasOwnProperty(e)&&(t[e]=this.style_obj.membrane.membrane_draw_opts[e]);this.current_resid_properties=this.deepCopy(this.parsed_protein_data.resid_properties),this.parsed_protein_data.hasOwnProperty("color_rules")&&this.createfillRules(this.parsed_protein_data.color_rules),this.draw_membrane(t);let r=this.parsed_protein_data.data.filter(function(e){return"helix"===e.type}),i=this.parsed_protein_data.data.filter(function(e){return"helix"===e.type||"pore"===e.type}),a=this.parsed_protein_data.data.filter(function(e){return"loop"===e.type&&!1!==e.dom_name}),n=this.parsed_protein_data.data.filter(function(e){return"loop"===e.type&&!1===e.dom_name&&e.prev_dom_name&&e.next_dom_name}),o=this.parsed_protein_data.data.filter(function(e){return"loop"===e.type&&!1===e.dom_name&&!1===e.prev_dom_name&&!e.next_dom_name}),s=this.parsed_protein_data.data.filter(function(e){return"loop"===e.type&&!1===e.dom_name&&e.prev_dom_name&&!e.next_dom_name}),l=this.parsed_protein_data.data.filter(function(e){return"loop"===e.type}),_=this.parsed_protein_data.data.filter(function(e){return"pore"===e.type});r=this.mergeDrawData("helix",r,this),r=this.createResidData(r),r=this.calculateResidOrientation(r,l),this.draw_helices(r),a=this.mergeDrawData("short_loops",a,this),a=this.createResidData(a),a=this.gen_shortloop_anchordata(a,i),this.draw_shortLoops(a),_=this.mergeDrawData("pore_loops",_,this),_=this.createResidData(_),_=this.gen_poreloop_anchordata(_,a),this.draw_poreLoops(_),n=this.mergeDrawData("long_loops",n,this),n=this.createResidData(n),n=this.gen_longloop_anchordata(n,r),this.draw_longLoops(n);let p=this.deepCopy(r).sort(function(e,t){return e.start-t.start});o=this.mergeDrawData("nter_loop",o,this),o=this.createResidData(o),o=this.gen_termini_anchordata(o[0],p[0],"N"),this.draw_termini(o),s=this.mergeDrawData("cter_loop",s,this),s=this.createResidData(s),s=this.gen_termini_anchordata(s[0],p[p.length-1],"C"),this.draw_termini(s),this.parsed_protein_data.residue_element_centroids=this.createResidElementToCentroidData(),this.parsed_protein_data.hasOwnProperty("residue_relations")&&this.draw_residue_relations(this.parsed_protein_data.residue_relations,this.parsed_protein_data.residue_element_centroids,this.parsed_protein_data.data),this.parsed_protein_data.hasOwnProperty("draw_symbols")&&(this.parsed_protein_data.draw_symbols=this.draw_symbols(this.parsed_protein_data.draw_symbols,this.parsed_protein_data.residue_element_centroids,this.parsed_protein_data.resid_properties,this.parsed_protein_data.data)),this.parsed_protein_data.hasOwnProperty("color_rules")&&this.parsed_protein_data.color_rules.length>0&&(d3.selectAll(".element_path").style("visibility","hidden"),d3.selectAll(".residue_path").style("visibility",""))}createfillRules(e){this.fillRules=[];for(let t=0;t<e.length;t++){let r={check_keys:[],check_values:[],color:void 0,range:void 0,domain:void 0,get:void 0},i=e[t],a=i.split(",")[0].split("&");for(let e=0;e<a.length;e++){let t=a[e];if(/\d+/.test(t)){let e=t.match(/\d+/)[0],i=t.split(e+"")[0];"Helix:"===i?(r.check_keys.push("type"),r.check_values.push(["helix"]),r.check_keys.push("dom_itype"),r.check_values.push([parseInt(e)])):"Loop:"===i?(r.check_keys.push("type"),r.check_values.push(["loop"]),r.check_keys.push("dom_itype"),r.check_values.push([parseInt(e)])):"Id:"===i?(r.check_keys.push("id"),r.check_values.push([parseInt(e)])):Object.keys(this.one_to_three).indexOf(i)>-1?(r.check_keys.push("res_ind"),r.check_values.push([parseInt(e)]),r.check_keys.push("res_1"),r.check_values.push([i])):Object.keys(this.three_to_one).indexOf(i)>-1?(r.check_keys.push("res_ind"),r.check_values.push([parseInt(e)]),r.check_keys.push("res_3"),r.check_values.push([i])):""===i&&(r.check_keys.push("res_ind"),r.check_values.push([parseInt(e)]))}else t.includes("Domain:")?(r.check_keys.push("dom_name"),r.check_values.push([t.split("Domain:")[1]])):Object.keys(this.one_to_three).indexOf(t)>-1?(r.check_keys.push("res_1"),r.check_values.push([t])):Object.keys(this.three_to_one).indexOf(t)>-1?(r.check_keys.push("res_3"),r.check_values.push([t])):"ALL"===t&&(r.check_keys.push("res_3"),r.check_values.push(this.deepCopy(Object.keys(this.three_to_one))))}let n=i.split(",")[1];n.includes("by:")?(r.get=n.split("by:")[1],r.range=i.split(",")[2].split(";"),r.domain=i.split(",")[3].split(";")):r.color=n,this.fillRules.push(r)}console.log("this.fillRules"),console.log(this.fillRules)}draw_membrane_box(e,t){let r=d3.select("#"+this.svg_id).append("g").attr("class","membrane_group").append("rect").attr("x",e.start_x).attr("y",e.start_y).attr("width",e.width).attr("height",e.height).attr("fill",e.fill).attr("opacity",e.opacity);t&&r.attr("id",t)}gen_lipid_head_data(e,t,r,i,a,n,o,s,l,_){let p=[];for(let c=0;c<e;c++){let e=c*l*2+t,d={cx:e,cy:r,r:l,rx:l,ry:_,fill:a,opacity:n,stroke:o,stroke_size:s,type:"upper"},h={cx:e,cy:i,r:l,rx:l,ry:_,fill:a,opacity:n,stroke:o,stroke_size:s,type:"lower"};p.push(d),p.push(h)}return p}ellipsis_equation_y(e,t,r,i,a){return Math.sqrt((1-Math.pow(e-t,2)/Math.pow(i,2))*Math.pow(a,2))+r}gen_lipid_tail_data(e,t,r,i,a,n,o,s,l){let _=[];for(let a=0;a<e.length;a++){let p=e[a],c=[];if(1===t){let e={fill:n,opacity:o,stroke:s,stroke_size:l,coords:[[p.cx,p.cy+p.ry]]};c.push(e)}else{let e=p.cx-p.rx+p.rx/1.8,t=p.cx+p.rx-p.rx/1.8,r=this.ellipsis_equation_y(e,p.cx,p.cy,p.rx,p.ry),i={fill:n,opacity:o,stroke:s,stroke_size:l,coords:[[e,r]]};c.push(i);let a={fill:n,opacity:o,stroke:s,stroke_size:l,coords:[[t,r]]};c.push(a)}if(r>1){for(let e=0;e<c.length;e++)return}else{let e=0,t=i;"lower"===p.type&&(e=-1*(2*p.ry-p.stroke_size),t=-1*i);for(let r=0;r<c.length;r++){let i=c[r].coords[c[r].coords.length-1];i[1]+=e,c[r].coords.push([i[0],i[1]+t])}}_.push(...c)}return _}draw_membrane_lipid(e,t,r){let i=e.lipid_head_radius_width*this.svg_width,a=i*(this.svg_height/this.svg_width)*2,n=e.width/(2*i),o=e.start_x+i/2,s=e.start_y+a,l=e.end_y-a,_=e.hfill,p=e.hstroke,c=e.hstroke_s,d=e.hopacity,h=this.gen_lipid_head_data(n,o,s,l,_,d,p,c,i,a),u=(this.svg_drawarea.height,this.svg_drawarea.membrane_height/2-(2*a+this.svg_height*e.lipid_tail_spacing));r||(r=.1);let m=e.tfill,y=e.topacity,g=e.tstroke,f=e.tstroke_s,w=this.gen_lipid_tail_data(h,e.lipid_tail_number,e.lipid_tail_breaks,u,r,m,y,g,f),x=d3.select("#"+this.svg_id).append("g").attr("class","membrane_group");x.append("g").attr("class","membrane_heads").selectAll(".lipid_heads").data(h).join(function(e){return e.append("ellipse").attr("class","lipid_heads").attr("cx",function(e){return e.cx}).attr("cy",function(e){return e.cy}).attr("rx",function(e){return e.rx}).attr("ry",function(e){return e.ry}).attr("fill",function(e){return e.fill}).attr("stroke",function(e){return e.stroke}).attr("stroke-width",function(e){return e.stroke_size}).attr("opacity",function(e){return e.opacity})},function(e){return e.remove()});let b=d3.line();x.append("g").attr("class","membrane_tails").selectAll(".lipid_tails").data(w).join(function(e){return e.append("path").attr("class","lipid_tails").attr("d",function(e){return b(e.coords)}).attr("fill",function(e){return e.fill}).attr("stroke",function(e){return e.stroke}).attr("stroke-width",function(e){return e.stroke_size}).attr("opacity",function(e){return e.opacity})},function(e){return e.remove()})}draw_membrane(e){"box"===this.style_obj.membrane.membrane_mode?this.draw_membrane_box(e,"membrane"):"lipid"===this.style_obj.membrane.membrane_mode&&this.draw_membrane_lipid(e,"membrane")}mergeDrawData(e,t,r){let i=e+"_draw_opts",a=r.style_obj.protein[i],n=Object.keys(a);if("dicts"===a.type)for(let e=0;e<t.length;e++)for(let r=0;r<n.length;r++){let i=n[r],o=a[i];if("domain_and_name"===o.type){let r=t[e].dom_name,a=t[e].dom_itype;t[e][i]=o[r][a]}else if("domain"===o.type){let r=t[e].dom_name;t[e][i]=o[r]}else if("name"===o.type){let r=t[e].dom_itype;t[e][i]=o[r]}}else if("single"===a.type)for(let e=0;e<t.length;e++)for(let r=0;r<n.length;r++){let i=n[r];"type"!==i&&(t[e][i]=a[i])}return t}createResidData(e){for(let t=0;t<e.length;t++){e[t].resids=[];let r=e[t].aas.split(""),i=e[t].start;for(let a=0;a<r.length;a++){let n={res_1:r[a],res_3:this.one_to_three[r[a]],res_ind:i};e[t].resids.push(n),i+=1}}return e}calculateResidOrientation(e,t){let r=t.reduce((e,t)=>(e[t.id]=t,e),{});for(let t=0;t<e.length;t++){"Cytoplasmic"===r[e[t].id-1].note?e[t].inverted=!0:e[t].inverted=!1}return e}createResidElementToCentroidData(){let e={},t=d3.selectAll(".single_residue_path"),r=[],i=this.svg_height,a=this.deepCopy,n=this,o=this.mergeDrawData;return t.each(function(t){let i="";i="helix"===t.type?"Domain"+t.dom_name+";Helix"+t.dom_itype:"pore"===t.type?"Domain"+t.dom_name+";Pore":"loop"===t.type&&t.dom_name?"Domain"+t.dom_name+";Loop"+t.dom_itype:"InterDomain"+t.dom_iname+";Loop";let s=d3.select(this).attr("resname"),l=t.res_ind;if(-1===r.indexOf(t.res_ind)&&r.push(t.res_ind),e.hasOwnProperty(l)){e[l].path_data.push(a(t));let r=a(e[l].point);e[l].point=[(r[0]+t.centroid[0])/2,(r[1]+t.centroid[1])/2]}else{let r={res_ind:l,resname:s,path_data:[a(t)],point:t.centroid,dom_aname:i};r=o("residue_centroid",[r],n)[0];for(const e in t)t.hasOwnProperty(e)&&!1===r.hasOwnProperty(e)&&(r[e]=t[e]);e[l]=r}}),d3.selectAll(".element_path_group").each(function(t){let r,s;if("helix"===t.type){r="Domain"+t.dom_name+";Helix"+t.dom_itype;let e=this.getBBox();s=[e.x+e.width/2,e.y+e.height/2]}else if("pore"===t.type){r="Domain"+t.dom_name+";Pore";let e=this.getBBox(),a=.5*d3.select(this).select("path").node().getTotalLength(),n=d3.select(this).select("path").node().getPointAtLength(a);s=[n.x,n.y];let o=.4*e.height;e.y>i/2&&(o*=-1),s[1]+=o}else if("loop"===t.type&&t.dom_name){r="Domain"+t.dom_name+";Loop"+t.dom_itype;let e=this.getBBox(),a=.5*d3.select(this).select("path").node().getTotalLength(),n=d3.select(this).select("path").node().getPointAtLength(a);s=[n.x,n.y];let o=.4*e.height;e.y>i/2&&(o*=-1),s[1]+=o}else{r="InterDomain"+t.dom_iname+";Loop";let e=this.getBBox(),a=.5*d3.select(this).select("path").node().getTotalLength(),n=d3.select(this).select("path").node().getPointAtLength(a);s=[n.x,n.y];let o=.4*e.height;e.y>i/2&&(o*=-1),s[1]+=o}let l={el_ind:t.id,elname:r,path_data:[a(t)],point:s},_=o("residue_centroid",[l],n)[0];_.circle_radius="5px",e[r]=_}),e}gen_shortloop_anchordata(e,t){let r=t.reduce((e,t)=>(e[t.dom_name+"_"+t.dom_i]=t,e),{});for(let t=0;t<e.length;t++){let i=e[t].dom_name,a=e[t].dom_i,n=e[t].note;e[t].anchorage={p1:void 0,p2:void 0};let o=r[i+"_"+(a-1)],s=r[i+"_"+(a+1)];"pore"===o.type?e[t].anchorage.p1=[o.draw_area.end_x,o.draw_area.start_y]:e[t].anchorage.p1="Extracellular"===n?o.anchor.top:o.anchor.bottom,"pore"===s.type?e[t].anchorage.p2=[s.draw_area.start_x,o.draw_area.start_y]:e[t].anchorage.p2="Extracellular"===n?s.anchor.top:s.anchor.bottom,e[t].anchorage.dist=this.euclideanDistance(e[t].anchorage.p1,e[t].anchorage.p2)}return e}gen_poreloop_anchordata(e,t){let r=t.reduce((e,t)=>(e[t.dom_name+"_"+t.dom_i]=t,e),{});for(let t=0;t<e.length;t++){let i=e[t].dom_name,a=e[t].dom_i;e[t].note;e[t].anchorage={p1:void 0,p2:void 0};let n=r[i+"_"+(a-1)],o=r[i+"_"+(a+1)];e[t].anchorage.p1=this.deepCopy(n.anchorage.p2),e[t].anchorage.p2=this.deepCopy(o.anchorage.p1),e[t].anchorage.dist=this.euclideanDistance(e[t].anchorage.p1,e[t].anchorage.p2)}return e}gen_longloop_anchordata(e,t){let r=t.reduce((e,t)=>(e[t.dom_name+"_"+t.dom_i]=t,e),{}),i={};for(let e=0;e<t.length;e++)!1===i.hasOwnProperty(t[e].dom_name)?i[t[e].dom_name]=t[e].dom_i:t[e].dom_i>i[t[e].dom_name]&&(i[t[e].dom_name]=t[e].dom_i);for(let t=0;t<e.length;t++){let a=e[t].prev_dom_name,n=e[t].next_dom_name;e[t].anchorage={p1:void 0,p2:void 0};let o=r[a+"_"+i[a]],s=r[n+"_1"];e[t].anchorage.p1=o.anchor.bottom,e[t].anchorage.p2=s.anchor.bottom,e[t].anchorage.dist=this.euclideanDistance(e[t].anchorage.p1,e[t].anchorage.p2)}return e}gen_termini_anchordata(e,t,r){let i;return e.terminus_type=r,"N"===r?("membrane"===this.style_obj.protein.nter_loop_draw_opts.calc_len.calc.start_loop?i=[e.draw_area.start_x,e.draw_area.start_y]:"edge"===this.style_obj.protein.nter_loop_draw_opts.calc_len.calc.start_loop&&(i=[e.draw_area.start_x,e.draw_area.end_y]),e.anchorage={p1:i,p2:t.anchor.bottom,dist:this.euclideanDistance(i,t.anchor.bottom)}):("membrane"===this.style_obj.protein.cter_loop_draw_opts.calc_len.calc.start_loop?i=[e.draw_area.end_x,e.draw_area.start_y]:"edge"===this.style_obj.protein.cter_loop_draw_opts.calc_len.calc.start_loop&&(i=[e.draw_area.end_x,e.draw_area.end_y]),e.anchorage={p1:t.anchor.bottom,p2:i,dist:this.euclideanDistance(i,t.anchor.bottom)}),e}createFillScale(e,t,r){let i=[],a=r[0];if((a+"").includes("min")){let t=d3.min(Object.keys(this.current_resid_properties)),r=d3.min(Object.keys(this.current_resid_properties));for(let a=t;a<r+1;a++){let t=this.current_resid_properties[a][e];i.push(t)}a=d3.min(i)}r[0]=a;let n=r[r.length-1];if((n+"").includes("max")){if(0===i.length){let t=d3.min(Object.keys(this.current_resid_properties)),r=d3.min(Object.keys(this.current_resid_properties));for(let a=t;a<r+1;a++){let t=this.current_resid_properties[a][e];i.push(t)}}n=d3.max(i)}return r[r.length-1]=n,d3.scaleLinear().domain(this.deepCopy(r)).range(this.deepCopy(t))}checkFillResidue(e,t){let r=!1,i=!1;for(let a=0;a<t.fillRules.length;a++){let n,o=t.fillRules[a],s=o.get,l=o.range,_=o.domain;o.get?(n=t.createFillScale(s,l,_),i=t.current_resid_properties[e.res_ind][s]):n=function(e){return o.color};let p=o.check_keys,c=!1;for(let t=0;t<p.length;t++){let r=p[t];if(!(o.check_values[t].indexOf(e[r])>-1)){c=!1;break}c=!0}c&&(r=n(i))}return[r,!1]}draw_helices_resids_box(e,t){let r=t.checkFillResidue;e.append("g").attr("id",function(e){return"g_helix_resids_"+e.dom_name+"_"+e.dom_itype}).attr("class","g_helix_resids residue_path").style("visibility","hidden").selectAll(+function(e){return".helices_rect_"+e.dom_name+"_"+e.dom_itype}).data(function(e){let r=e.aas.split(""),i=(a=e.aas.length,n=e.start,t.rangeArray(a,n));var a,n;e.inverted&&(r.reverse(),i.reverse());let o=e.draw_area.height/r.length,s=[];for(let a=0;a<r.length;a++){let n=r[a],l=t.one_to_three[r[a]],_=i[a],p=e.draw_area.start_x,c=e.draw_area.start_y+o*a,d=e.draw_area.width,h=o;s.push({id:e.id,type:e.type,dom_name:e.dom_name,dom_iname:e.dom_iname,dom_itype:e.dom_itype,start_x:p,start_y:c,width:d,height:h,fill:e.fill,stroke:e.fill,stroke_width:e.stroke_width,opacity:e.opacity,res_1:n,res_3:l,res_ind:_,centroid:[(p+d)/2,(c+h)/2]})}return s}).join(function(e){return e.append("rect").attr("class",function(e){return"helices_rect_"+e.dom_name+"_"+e.dom_itype+" single_residue_path"}).attr("resname",function(e){return e.res_3+e.res_ind}).attr("x",function(e){return e.start_x}).attr("y",function(e){return e.start_y}).attr("width",function(e){return e.width}).attr("height",function(e){return e.height}).attr("fill",function(e){let i=r(e,t)[0];return i||e.fill}).attr("opacity",function(e){let i=r(e,t)[1];return i||e.opacity}).attr("stroke",function(e){let i=r(e,t)[0];return i||e.stroke}).attr("stroke-width",function(e){return e.stroke_size})},function(e){return e.transition().attr("fill",function(e){let i=r(e,t)[0];return i||e.fill}).attr("opacity",function(e){let i=r(e,t)[1];return i||e.opacity}).attr("stroke",function(e){let i=r(e,t)[0];return i||e.stroke})},function(e){return e.remove()})}draw_helices_box(e,t){let r=this,i=this.draw_helices_resids_box,a=d3.select("#"+this.svg_id).append("g").attr("class","helices_group");a.selectAll(".helices_rect").data(e).join(function(e){let t=e.append("g").attr("id",function(e){return"g_helix_"+e.dom_name+"_"+e.dom_itype}).attr("class","element_path_group");return t.append("rect").attr("class","helices_rect element_path").attr("x",function(e){return e.draw_area.start_x}).attr("y",function(e){return e.draw_area.start_y}).attr("width",function(e){return e.draw_area.width}).attr("height",function(e){return e.draw_area.height}).attr("fill",function(e){return e.fill}).attr("opacity",function(e){return e.opacity}).attr("stroke",function(e){return e.stroke}).attr("stroke-width",function(e){return e.stroke_size}),i(t,r),t},function(e){return e.remove()}),t&&a.attr("id",t)}draw_helices_resids_cylinder(e,t){let r=function(e,r){return t.checkFillResidue(e,r)},i=e.append("g").attr("id",function(e){return"g_helix_resids_"+e.dom_name+"_"+e.dom_itype}).attr("class","g_helix_resids residue_path").style("visibility","hidden");i.selectAll(+function(e){return".helices_cylinders_"+e.dom_name+"_"+e.dom_itype}).data(function(e){let r=e.aas.split(""),i=(a=e.aas.length,n=e.start,t.rangeArray(a,n));var a,n;e.inverted&&(r.reverse(),i.reverse());let o=e.draw_area.height/r.length,s=[];for(let a=0;a<r.length;a++){let n=r[a],l=t.one_to_three[r[a]],_=i[a],p=e.draw_area.start_x,c=e.draw_area.start_y+o*a,d=e.draw_area.width,h=o;s.push({id:e.id,type:e.type,dom_name:e.dom_name,dom_iname:e.dom_iname,dom_itype:e.dom_itype,start_x:p,start_y:c,width:d,height:h,fill:e.fill,stroke:e.fill,stroke_width:e.stroke_width,opacity:e.opacity,res_1:n,res_3:l,res_ind:_,centroid:[(p+d)/2,(c+h)/2]})}return s}).join(function(e){return e.append("rect").attr("class",function(e){return"helices_rect_"+e.dom_name+"_"+e.dom_itype+" single_residue_path"}).attr("resname",function(e){return e.res_3+e.res_ind}).attr("x",function(e){return e.start_x}).attr("y",function(e){return e.start_y}).attr("width",function(e){return e.width}).attr("height",function(e){return e.height}).attr("stroke-width",function(e){return e.stroke_size}).attr("fill",function(e){let i=r(e,t)[0];return i||e.fill}).attr("opacity",function(e){let i=r(e,t)[1];return i||e.opacity}).attr("stroke",function(e){let i=r(e,t)[0];return i||e.stroke}).attr("stroke-dasharray",function(e,t){if(t===i.data().length-1)return e.width+e.height+","+e.width})},function(e){return e.transition().attr("fill",function(e){let i=r(e,t)[0];return i||e.fill}).attr("opacity",function(e){let i=r(e,t)[1];return i||e.opacity}).attr("stroke",function(e){let i=r(e,t)[0];return i||e.stroke})})}draw_helices_cylinder(e,t){let r=this.checkFillResidue,i=this,a=this.draw_helices_resids_cylinder,n=this.svg_height/this.svg_width,o=e[0].draw_area.width/2,s=o*n,l=this.style_obj.protein.helix_draw_opts.top_cylinder_stroke,_=this.style_obj.protein.helix_draw_opts.top_cylinder_stroke_size,p=this.style_obj.protein.helix_draw_opts.bottom_cylinder_stroke,c=this.style_obj.protein.helix_draw_opts.bottom_cylinder_stroke_size,d=d3.select("#"+this.svg_id).append("g").attr("class","helices_group");d.selectAll(".helices_cylinder").data(e).join(function(e){let t=e.append("g").attr("id",function(e){return"g_helix_"+e.dom_name+"_"+e.dom_itype}).attr("class","helices_cylinder element_path_group");return t.append("ellipse").attr("class","helices_cyl_bottom_circle").attr("cx",function(e){return e.draw_area.start_x+o}).attr("cy",function(e){return e.draw_area.end_y}).attr("rx",o).attr("ry",s).attr("fill",function(e){let t=r(e.resids[e.resids.length-1],i)[0];return t||e.fill}).attr("opacity",function(e){let t=r(e.resids[e.resids.length-1],i)[1];return t||e.opacity}).attr("stroke",p).attr("stroke-width",c),t.append("rect").attr("class","helices_cyl_rect element_path").attr("x",function(e){return e.draw_area.start_x}).attr("y",function(e){return e.draw_area.start_y}).attr("width",function(e){return e.draw_area.width}).attr("height",function(e){return e.draw_area.height}).attr("fill",function(e){return e.fill}).attr("opacity",function(e){return e.opacity}).attr("stroke",function(e){return e.stroke}).attr("stroke-width",function(e){return e.stroke_size}).attr("stroke-dasharray",function(e){return e.draw_area.width+e.draw_area.height+","+e.draw_area.width}),a(t,i),t.append("ellipse").attr("class","helices_cyl_top_circle").attr("cx",function(e){return e.draw_area.start_x+o}).attr("cy",function(e){return e.draw_area.start_y}).attr("rx",o).attr("ry",s).attr("fill",function(e){let t=r(e.resids[0],i)[0];return t||e.fill}).attr("opacity",function(e){let t=r(e.resids[0],i)[1];return t||e.opacity}).attr("stroke",l).attr("stroke-width",_),t},function(e){e.select(".helices_cyl_bottom_circle").transition().attr("fill",function(e){let t=r(e.resids[e.resids.length-1],i)[0];return t||e.fill}).attr("opacity",function(e){let t=r(e.resids[e.resids.length-1],i)[1];return t||e.opacity}),e.select(".helices_cyl_top_circle").transition().attr("fill",function(e){let t=r(e.resids[0],i)[0];return t||e.fill}).attr("opacity",function(e){let t=r(e.resids[0],i)[1];return t||e.opacity});return e},function(e){return e.remove()}),t&&d.attr("id",t)}buildPathStringFromData(e){let t=["M"];for(let r=0;r<e.points.length;r++){let i=e.points[r];switch(i.type){case"curvB":t.push("C");for(let e=0;e<i.p.length;e++){let r=i.p[e];t.push(r)}break;case"lineP":t.push("L"),t.push(i.p);break;default:t.push(i.p)}}!0===e.pathclose&&t.push("z");var r="";for(let e=0;e<t.length-1;e++)r+=t[e]+" ";return r+=t[t.length-1]}pathStringToStringPoints(e,t){let r=e.attr("d").split(/(?=[MCL])/g);if(t){let e=[];for(let i=0;i<r.length;i++){let a=r[i];a.indexOf(t)>-1&&e.push(a)}return 1===e.length?e[0]:e}return r}dotToCoords(e){let t=[];return e.x?t.push(e.x):t.push(e[0]),e.y?t.push(e.y):t.push(e[1]),t}calculateDotArrayMiddlePoint(e,t){return[(e[0]+t[0])/2,(e[1]+t[1])/2]}calculateDotMiddlePoint(e,t){return[(e.x+t.x)/2,(e.y+t.y)/2]}generateXMidPts(e,t,r){let i=[];i.push([e.x,e.y]);let a=(t.x-e.x)/r,n=(t.y-e.y)/r;for(let t=1;t<=r;t++)i.push([e.x+a*t,e.y+n*t]);return i.push([t.x,t.y]),i}pathSegmentToXYPoints(e,t,r,i,a){i||(i=.25),a||(a=i);let n=[];for(var o=t;o<=r+a;o+=i){let t=e.getPointAtLength(o);n.push([t.x,t.y])}return n}gen_helix_cartoon_halfturn_data(e){let t=e.aanum,r=e.draw_area,i=r.start_y,a=r.start_x,n=r.width,o=r.height,s=e.inverted,l=e.aas.split(""),_=this.rangeArray(e.aas.length,e.start);s&&(l.reverse(),_.reverse());var p=!1,c=!1,d=0;let h=0;for(let e=0;e<t;e++)0===h?(1,d+=1,"back",p=!0,c=!1,h+=1):3===h?(d+=1,"front",c=!0,p=!1,h=0):h+=1;let u=this.stringToChunksSkip(e.aas,3,1),m=this.stringToChunksSkip(e.aas.slice(2),3,1),y=u.filter(function(e,t){let r=t%2==0;return(!c||t!==u.length-1)&&r}),g=m.filter(function(e,t){return(!p||t!==u.length-1)&&t%2==0});var f=o/((d=y.length+g.length)/2)/2;let w=this.style_obj.protein.helix_draw_opts.thickness;var x=n;let b=x,v=f,k=b*this.style_obj.protein.helix_draw_opts.x_to_end_prop,I=v*w,P=this.style_obj.protein.helix_draw_opts.y_to_mid_prop,D=e.back_fill,L=e.fill,j=this.style_obj.protein.helix_draw_opts.hh_stroke_size,C=this.style_obj.protein.helix_draw_opts.back_helix_stroke,S=this.style_obj.protein.helix_draw_opts.front_helix_stroke,A=0;var O=[];let R=0;var B=[];for(let t=0;t<d;t++){var T=t%2,z=a+x*T,M=i+t*f;let r;if(r=0===t?[2,2,1]:t===d-1?[1,2,2]:[2,3,2],0==T){let i=[],a=y[A].split(""),n=2*t;for(let t=0;t<a.length;t++){a[t];i.push({id:e.id,type:e.type,dom_name:e.dom_name,dom_iname:e.dom_iname,dom_itype:e.dom_itype,res_1:l[n],res_3:this.one_to_three[l[n]],res_ind:_[n],opacity:e.opacity,fill:D,stroke_color:C,stroke_size:j}),n+=1}let o=z+b,s=0;2===i.length?(o=z+b/3*2,r=r.slice(0,2)):1===i.length&&(o=z+b/3,r=r.slice(0,1)),t===d-1&&(s=0);let p=M+(v+s),c=z+k,h=o-k,u=M+I+((v+s-I)/2+(v+s-I)*P),m=M+I+((v+s-I)/2-(v+s-I)*P),g=p-I-((v+s-I)/2+(v+s-I)*P),f=p-I-((v+s-I)/2-(v+s-I)*P);A+=1,O.push({id:e.id,type:e.type,dom_name:e.dom_name,dom_iname:e.dom_iname,dom_itype:e.dom_itype,resids:i,pathclose:!0,fill:D,stroke_color:C,stroke_size:j,parts_division:r,points:[{turn_index:t,pathtype:"bck",type:"addP",p:z+","+M},{turn_index:t,pathtype:"bck",type:"addP",p:z+","+(M+I)},{turn_index:t,pathtype:"bck",type:"curvB",p:[c+","+u,h+","+m,o+","+p]},{turn_index:t,pathtype:"bck",type:"lineP",p:o+","+(p-I)},{turn_index:t,pathtype:"bck",type:"curvB",p:[h+","+g,c+","+f,z+","+M]}]})}else if(1==T){M=i+(t-.5)*f;var N=i+t*f,H=i+(t+.5)*f;let a=[],n=g[R].split(""),o=2*t;for(let t=0;t<n.length;t++){n[t];a.push({id:e.id,type:e.type,dom_name:e.dom_name,dom_iname:e.dom_iname,dom_itype:e.dom_itype,res_1:l[o],res_3:this.one_to_three[l[o]],res_ind:_[o],opacity:e.opacity,fill:L,stroke_color:S,stroke_size:j}),o+=1}let s=z-b;2===a.length?(s=z-b/3,r=r.slice(0,2)):1===a.length&&(s=z-b/3*2,r=r.slice(0,1)),t===d-1&&(H=N);let p=H+v,c=N+v,h=z-k,u=s+k,m=N+I+((v-I)/2+(v-I)*P),y=N+I+((v-I)/2-(v-I)*P),w=c-I-((v-I)/2+(v-I)*P),x=c-I-((v-I)/2-(v-I)*P);R+=1,B.push({id:e.id,type:e.type,dom_name:e.dom_name,dom_iname:e.dom_iname,dom_itype:e.dom_itype,resids:a,pathclose:!0,fill:L,stroke_color:S,stroke_size:j,parts_division:r,points:[{turn_index:t,pathtype:"frt",type:"addP",p:z+","+M},{turn_index:t,pathtype:"frt",type:"addP",p:z+","+(M+I)},{turn_index:t,pathtype:"frt",type:"curvB",p:[h+","+m,u+","+y,s+","+p]},{turn_index:t,pathtype:"frt",type:"lineP",p:s+","+(p-I)},{turn_index:t,pathtype:"frt",type:"curvB",p:[u+","+w,h+","+x,z+","+M]}]})}}return{back:O,front:B,half_turns_number:d,aanum_parity:t%2==0}}getHalfHelixBoundaries(e,t,r,i){let a=(t-2*r)/2,n=a/3,o=a/i.size,s=a,l=i.curve_steps[0].size*o;i.curve_steps[0].csize=l,s-=l;let _=!1;2===i.curve_steps.length&&(_=i.curve_steps[1].size*o,i.curve_steps[1].csize=_,s-=_);let p=n*this.style_obj.protein.helix_draw_opts.aa_area_perc_displacement,c=l*this.style_obj.protein.helix_draw_opts.aa_area_perc_displacement,d=s*this.style_obj.protein.helix_draw_opts.aa_area_perc_displacement,h=!1;2===i.curve_steps.length&&(h=_*this.style_obj.protein.helix_draw_opts.aa_area_perc_displacement);let u=r,m=u+l,y=!1;2===i.curve_steps.length&&(y=u+(l+_));let g=2*r+a,f=g+s,w=!1;2===i.curve_steps.length&&(w=g+(_+s));let x=e.getPointAtLength(m+c),b=!1,v=e.getPointAtLength(f+d),k=!1;2===i.curve_steps.length&&(b=e.getPointAtLength(y+d),k=e.getPointAtLength(w+c));let I={x:0,y:0,path_len_to_pt:0},P={left:this.deepCopy(I)},D={left:this.deepCopy(I)};return 2===i.curve_steps.length&&(P.right=this.deepCopy(I),D.right=this.deepCopy(I)),P.left.x=x.x,P.left.y=x.y,P.left.path_len_to_pt=m+p,2===i.curve_steps.length&&(P.right.x=b.x,P.right.y=b.y,P.right.path_len_to_pt=y+p),2===i.curve_steps.length&&(D.right.x=v.x,D.right.y=v.y,D.right.path_len_to_pt=f+p),D.left.x=k.x,D.left.y=k.y,D.left.path_len_to_pt=w+p,1===i.curve_steps.length&&(D.left.x=v.x,D.left.y=v.y,D.left.path_len_to_pt=f+p),[P,D,l,_]}drawSingleHalfHelixResidue(e,t,r,i){let a=this.checkFillResidue,n=this,o=d3.select(i),s=d3.select("#"+t+"_resids").append("g");e.resids[0].path_d=o.attr("d"),s.selectAll("."+t+"_resids_"+r).data(e.resids).join(function(e){e.append("path").attr("class",t+"_resids_"+r+" single_residue_path").attr("resname",function(e){return e.res_3+e.res_ind}).attr("d",function(e){return e.path_d}).attr("stroke",function(e){let t=a(e,n)[0];return t||e.stroke}).attr("fill",function(e){let t=a(e,n)[0];return t||e.fill}).attr("opacity",function(e){let t=a(e,n)[1];return t||e.opacity}).attr("stroke-width",function(e){return e.stroke_size})},function(e){return e.transition().attr("stroke",function(e){let t=a(e,n)[0];return t||e.fill}).attr("fill",function(e){let t=a(e,n)[0];return t||e.fill}).attr("opacity",function(e){let t=a(e,n)[1];return t||e.opacity})},function(e){return e.remove()});let l=document.getElementsByClassName(t+"_resids_"+r);for(let e=0;e<l.length;e++){const t=l[e];let r=t.getBBox(),i=r.x+r.width/2,a=r.y+r.height/2,n=d3.select(t).datum();n.centroid=[i,a],d3.select(t).datum(n),"NaN"===n.res_ind&&d3.select(t).remove()}}drawHalfHelixResidPolygons(e,t,r,i,a,n,o,s,l,_){let p=d3.select("#"+t+"_resids").append("g");var c=d3.line().curve(d3.curveCardinal);this.calculateDotMiddlePoint(n.left,o.left);let d=!1;_[1]&&(d=this.calculateDotMiddlePoint(n.right,o.right));this.dotToCoords(n.left),this.dotToCoords(o.left);let h=this.generateXMidPts(n.left,o.left,10),u=this.generateXMidPts(o.left,n.left,10),m=!1,y=!1;_[1]&&(m=this.generateXMidPts(n.right,o.right,10),y=this.generateXMidPts(o.right,n.right,10));let g=[];_[1]?((g=[[],[],[]])[0].push(...this.pathSegmentToXYPoints(i,0,s,5)),g[0].push(...this.pathSegmentToXYPoints(i,s,n.left.path_len_to_pt,5)),g[0].push(...h),g[0].push(...this.pathSegmentToXYPoints(i,o.left.path_len_to_pt,a,2)),g[1].push(...u),g[1].push(...this.pathSegmentToXYPoints(i,n.left.path_len_to_pt,n.right.path_len_to_pt,2)),g[1].push(...m),g[1].push(...this.pathSegmentToXYPoints(i,o.right.path_len_to_pt,o.left.path_len_to_pt,2)),g[2].push(...y),g[2].push(...this.pathSegmentToXYPoints(i,n.right.path_len_to_pt,s+_[1],5)),g[2].push(...this.pathSegmentToXYPoints(i,s+_[1],2*s+_[1],5)),g[2].push(...this.pathSegmentToXYPoints(i,2*s+_[1],o.right.path_len_to_pt,2))):((g=[[],[]])[0].push(...this.pathSegmentToXYPoints(i,0,s,5)),g[0].push(...this.pathSegmentToXYPoints(i,s,n.left.path_len_to_pt,5)),g[0].push(...h),g[0].push(...this.pathSegmentToXYPoints(i,o.left.path_len_to_pt,a,2)),g[1].push(...u),g[1].push(...this.pathSegmentToXYPoints(i,s+_[0],s+(l-_[0]),2)),g[1].push(...this.pathSegmentToXYPoints(i,s+(l-_[0]),2*s+l,2)),g[1].push(...this.pathSegmentToXYPoints(i,2*s+l,2*s+(l-_[0]+l),2)));for(let t=0;t<g.length;t++){let r=g[t];e.resids[t].pathpts=r}let f=this,w=this.checkFillResidue;p.selectAll("."+t+"_resids_"+r).data(e.resids).join(function(e){e.append("path").attr("class",t+"_resids_"+r+" single_residue_path").attr("resname",function(e){return e.res_3+e.res_ind}).attr("d",function(e){return c(e.pathpts)}).attr("stroke",function(e){let t=w(e,f)[0];return t||e.stroke}).attr("fill",function(e){let t=w(e,f)[0];return t||e.fill}).attr("opacity",function(e){let t=w(e,f)[1];return t||e.opacity}).attr("stroke-width",function(e){return e.stroke_size})},function(e){return e.transition().attr("stroke",function(e){let t=w(e,f)[0];return t||e.fill}).attr("fill",function(e){let t=w(e,f)[0];return t||e.fill}).attr("opacity",function(e){let t=w(e,f)[1];return t||e.opacity})},function(e){return e.remove()});let x=document.getElementsByClassName(t+"_resids_"+r);for(let e=0;e<x.length;e++){const t=x[e];let r=t.getBBox(),i=r.x+r.width/2,a=r.y+r.height/2,n=d3.select(t).datum();n.centroid=[i,a],d3.select(t).datum(n),"NaN"===n.res_ind&&d3.select(t).remove()}}draw_helices_resids_cartoon(e,t){d3.select("#g_helix_"+e[0].dom_name+"_"+e[0].dom_itype).append("g").attr("id",function(){return t+"_resids"}).attr("class","g_helix_resids residue_path").style("visibility","hidden");let r=document.getElementsByClassName(t);for(let e=0;e<r.length;e++){let i=r[e],a=i.getBBox(),n=(a.x,a.width,a.y,a.height,d3.select(i)),o=n.datum(),s=(o.points[0].pathtype,o.points[0].turn_index,o.parts_division),l=this.pathStringToStringPoints(n,"M").split(" "),_=Math.abs(parseFloat(l[1].split(",")[1])-parseFloat(l[2].split(",")[1])),p=i.getTotalLength(),c=(p-2*_)/2,d={size:d3.sum(s),curve_steps:[]};for(let e=0;e<s.length-1;e++)d.curve_steps.push({size:s[e],csize:void 0});if(s.length>1){let r=!1;r=this.getHalfHelixBoundaries(i,p,_,d),this.drawHalfHelixResidPolygons(o,t,e,i,p,r[0],r[1],_,c,[r[2],r[3]])}else this.drawSingleHalfHelixResidue(o,t,e,i)}}draw_helices_cartoon(e){let t=this.buildPathStringFromData,r=d3.select("#"+this.svg_id).append("g").attr("class","helices_group");for(let i=0;i<e.length;i++){let a=e[i],n=this.gen_helix_cartoon_halfturn_data(a),o=r.append("g").attr("id",function(){return"g_helix_"+a.dom_name+"_"+a.dom_itype}).attr("class","element_path_group").datum(a),s="bck_h_hel_path_"+a.dom_name+"_"+a.dom_itype;o.append("g").attr("class","back_half_helix element_path").selectAll("."+s).data(n.back).enter().append("path").attr("class",s).attr("d",function(e){return t(e)}).attr("stroke",function(e){return e.stroke_color}).attr("stroke-width",function(e){return e.stroke_size}).attr("fill",function(e){return e.fill}),this.draw_helices_resids_cartoon(n.back,s);let l="frt_h_hel_path_"+a.dom_name+"_"+a.dom_itype;o.append("g").attr("class","front_half_helix element_path").selectAll("."+l).data(n.front).enter().append("path").attr("class",l).attr("d",function(e){return t(e)}).attr("stroke",function(e){return e.stroke_color}).attr("stroke-width",function(e){return e.stroke_size}).attr("fill",function(e){return e.fill}),this.draw_helices_resids_cartoon(n.front,l)}}get_helices_endpoints(e,t){for(let r=0;r<t.length;r++){let i,a,n=t[r],o=document.getElementById("g_helix_"+n.dom_name+"_"+n.dom_itype),s=o.getElementsByClassName("g_helix_resids"),l=o.getBBox(),_=0;for(let e=0;e<s.length;e++){let t=s[e].childNodes;for(let e=0;e<t.length;e++){let r=t[e],n=r.getBoundingClientRect();n.y>_&&(a=r,_=n.y,i=r.getBBox())}}let p=l.x+l.width/2,c=i.x+i.width/2;if("cartoon"===e){p=l.x,c=i.x+i.width;let e=a.querySelector("path");d3.select(e).attr("class").includes("frt")&&(c=i.x)}let d=l.y,h=i.y+i.height;t[r].anchor={top:[p,d],bottom:[c,h]}}return t}draw_helices(e){return"box"===this.style_obj.protein.helix_mode?this.draw_helices_box(e,"helices"):"cylinder"===this.style_obj.protein.helix_mode?this.draw_helices_cylinder(e,"helices"):"cartoon"===this.style_obj.protein.helix_mode&&this.draw_helices_cartoon(e),e=this.get_helices_endpoints(this.style_obj.protein.helix_mode,e)}createVector(e,t){return[e[0]-t[0],e[1]-t[1]]}normalizeVector(e){let t=Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2));return[e[0]/t,e[1]/t]}scaleVector(e,t){return[e[0]*t,e[1]*t]}rotate90(e,t,r){return t||(t="clockwise"),r||(r=[0,0]),"clockwise"===t?[e[1]+r[0],-1*e[0]+r[1]]:[-1*e[1]+r[0],e[0]+r[1]]}rotateByAng(e,t,r){let i=e[0],a=e[1],n=t[0],o=t[1];var s=Math.PI/180*r,l=Math.cos(s),_=Math.sin(s);return[l*i+_*a+n,l*a-_*i+o]}getPointAtAngleDistance(e,t,r,i){var a=[];return a.push(Math.round(Math.cos(r*Math.PI/180)*i+e)),a.push(Math.round(Math.sin(r*Math.PI/180)*i+t)),a}find_angle(e,t,r){var i=Math.sqrt(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2)),a=Math.sqrt(Math.pow(t[0]-r[0],2)+Math.pow(t[1]-r[1],2)),n=Math.sqrt(Math.pow(r[0]-e[0],2)+Math.pow(r[1]-e[1],2));return Math.acos((a*a+i*i-n*n)/(2*a*i))*(180/Math.PI)}getGhostPathLength(e,t){let r=d3.line().curve(d3.curveNatural),i=d3.select("#"+this.svg_id).append("g").attr("id",function(){if(t)return"par"+t}).attr("visibility","hidden"),a=i.append("path").attr("id",function(){if(t)return t}).attr("d",function(){return r(e)}).node().getTotalLength();return a=this.roundDecimals(a,2),t||i.remove(),a}euclideanDistance(e,t){return Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2))}generateSimpleLoopPoints(e,t,r,i,a,n){i||(i=1),a||(a=0);let o=e[0],s=e[1],l=t[0],_=t[1],p=(o+l)/2,c=[[o,s],[p+a*(p-o),(s+_)/2+-1*i*r],[l,_]];return n&&"fold"===n.type&&(c=this.foldAddition(c,n)),c}generateSwirlLoopPoints(e,t,r,i,a,n,o){n||(n=1);let s=e[0],l=e[1],_=t[0],p=t[1],c=(s+_)/2,d=(l+p)/2,h=r*(c-s);return[[s,l],[s-h,d+-1*n*(i*a)],[c-h,d+-1*n*i],[_-h,d+-1*n*(i*a)],[_,p]]}generateBulbLoopPoints(e,t,r,i,a,n,o,s){n||(n=1),o||(o=0);let l=e[0],_=e[1],p=t[0],c=t[1],d=(l+p)/2,h=(_+c)/2,u=[[l,_],[l-r,h+-1*n*(i*a)],[d+o*(d-l),h+-1*n*i],[p+r,h+-1*n*(i*a)],[p,c]];return s&&"fold"===s.type&&(u=this.foldAddition(u,s)),u}generateMushRoomLoopPoints(e,t,r,i,a,n,o,s,l,_){s||(s=1),l||(l=0);let p=e[0],c=e[1],d=t[0],h=t[1],u=(p+d)/2,m=(c+h)/2,y=[[p,c],[u-a*(u-p),m+-1*s*i*n],[p-r,m+-1*s*i*o],[u+l*(u-p),m+-1*s*i],[d+r,m+-1*s*i*o],[u+a*(u-p),m+-1*s*i*n],[d,h]];return _&&"fold"===_.type&&(y=this.foldAddition(y,_)),y}generateSkewedSimpleLoopPoints(e,t,r,i,a){a||(a=1);let n=e[0],o=e[1],s=t[0],l=t[1],_=(n+s)/2;return[[n,o],[_+r*(_-n),(o+l)/2+-1*a*i],[s,l]]}generateNWaveCurves(e,t,r,i,a,n,o){n||(n=!0);let s=[],l=e[0],_=e[1],p=t[0],c=t[1];if(o)if(c>_){let r=this.createVector(t,e),i=this.rotateByAng(r,[l,_],o);p=i[0],c=i[1]}else{let r=this.createVector(e,t),i=this.rotateByAng(r,[p,c],o);l=i[0],_=i[1]}s.push([l,_]);let d=(p-l)/(r+1),h=(c-_)/(r+1),u=l,m=_;for(let e=1;e<=r;e++){let t,r=l+d*e,o=_+h*e,p=i*a[e-1];t=!0===n?"clockwise":"anticlockwise",n=!n;let c=this.createVector([r+0,o+0],[u,m]),y=this.normalizeVector(c),g=this.scaleVector(y,p),f=this.rotate90(g,t,[r,o]);s.push(f),u=r,m=o}return s.push([p,c]),s}foldAddition(e,t){let r=[],i=Math.ceil(e.length/2),a=this.getGhostPathLength(e,"ghostParent"),n=document.getElementById("ghostParent"),o=a*t.start,s=n.getPointAtLength(o),l=[s.x,s.y];r=this.deepCopy(e).slice(0,i);let _=[],p=this.calculateDotArrayMiddlePoint(e[0],e[e.length-1]);0!==t.x_scaling&&(p[0]=p[0]+this.euclideanDistance(p,e[e.length-1])*t.x_scaling);let c=this.deepCopy(e);c=c.slice(1,e.length-1);for(let e=0;e<t.heights.length;e++){let r=t.heights[e],i=[];if(e%2==0)for(let e=c.length-1;e>=0;e--){let t=c[e],a=this.euclideanDistance(t,p)*r,n=this.createVector(t,p),o=this.normalizeVector(n),s=this.scaleVector(o,a),l=this.createVector(t,s);i.push(l)}else for(let e=0;e<c.length;e++){let t=c[e],a=this.euclideanDistance(t,p)*r,n=this.createVector(t,p),o=this.normalizeVector(n),s=this.scaleVector(o,a),l=this.createVector(t,s);i.push(l)}_.push(...i)}return r.push(l),r.push(...this.deepCopy(_)),r.push(e[e.length-1]),d3.select("#parghostParent").remove(),r}makeLoopScaling(e,t){let r;return"linear"===t.calc.scale?r=d3.scaleLinear().domain(e.domain).range(e.range):"power"===t.calc.scale?r=d3.scalePow().exponent(t.calc.exponent).domain(e.domain).range(e.range):"log"===t.calc.scale&&(r=d3.scaleLog().base(t.calc.base).domain(e.domain).range(e.range)),r}checkWaveFold(e,t){let r,i,a;if(e.hasOwnProperty("dom_name")&&e.hasOwnProperty("dom_itype")&&(i=e.dom_name,a=e.dom_itype),i&&a)r=t[i][a];else if(e.hasOwnProperty("dom_iname")){let i=e.dom_iname;i&&(r=t[i])}return r}checkForNaN(e){for(let t=0;t<e.length;t++)if(isNaN(e[t][0])||isNaN(e[t][1]))return!0;return!1}calculateFixedPointData(e,t,r){let i,a;"simple"===r.type?i=this.svg_height*t.calc.height:"swirl"===r.type?i=this.svg_height*t.calc.height:"bulb"===r.type?(i=this.svg_height*t.calc.height,a=this.svg_width*t.calc.width):"mushroom"===r.type&&(i=this.svg_height*t.calc.height,a=this.svg_width*t.calc.width);for(let t=0;t<e.length;t++){let n,o=e[t].anchorage.p1,s=e[t].anchorage.p2,l=1;if("Cytoplasmic"===e[t].note&&(l=-1),"simple"===r.type){let a,_=0;r.calc.hasOwnProperty("x_skew_perc")&&(_=r.calc.x_skew_perc),r.calc.hasOwnProperty("add_wave_fold")&&(a=this.checkWaveFold(e[t],r.calc.add_wave_fold)),n=this.generateSimpleLoopPoints(o,s,i,l,_,a)}else if("swirl"===r.type){let e=r.calc.swirl_x,t=r.calc.perc_step_y;n=this.generateSwirlLoopPoints(o,s,e,i,t,l)}else if("bulb"===r.type){let _,p=r.calc.perc_step_y;r.calc.hasOwnProperty("add_wave_fold")&&(_=this.checkWaveFold(e[t],r.calc.add_wave_fold));let c=0;r.calc.hasOwnProperty("x_skew_perc")&&(c=r.calc.x_skew_perc),n=this.generateBulbLoopPoints(o,s,a,i,p,l,c,_)}else if("mushroom"===r.type){let _,p=r.calc.perc_step_y1,c=r.calc.perc_step_y2,d=r.calc.perc_center_x;r.calc.hasOwnProperty("add_wave_fold")&&(_=this.checkWaveFold(e[t],r.calc.add_wave_fold,h,_));let h=0;r.calc.hasOwnProperty("x_skew_perc")&&(h=r.calc.x_skew_perc),n=this.generateMushRoomLoopPoints(o,s,a,i,d,p,c,l,h,_)}e[t].points=n}return e}calculateScaledPointData(e,t,r){let i,a,n=e.map(function(e,t){return[e.aanum,t]}).sort(function(e,t){return t[0]-e[0]}),o=n[0][0],s=(n[0][1],{});"simple"===r.type?s.y_step={}:"swirl"===r.type?s.y_step={}:"bulb"===r.type?(s.y_step={},s.x_step={}):"mushroom"===r.type&&(s.y_step={},s.x_step={}),"simple"===r.type?(i=this.svg_height*t.calc.height,s.y_step.max_step=i/r.calc.y_step):"swirl"===r.type?(i=this.svg_height*t.calc.height,s.y_step.max_step=i/r.calc.y_step):"bulb"===r.type?(i=this.svg_height*t.calc.height,a=this.svg_width*t.calc.width,s.y_step.max_step=i/r.calc.y_step,s.x_step.max_step=a/r.calc.x_step):"mushroom"===r.type&&(i=this.svg_height*t.calc.height,a=this.svg_width*t.calc.width,s.y_step.max_step=i/r.calc.y_step,s.x_step.max_step=a/r.calc.x_step);for(const e in s)s.hasOwnProperty(e)&&(s[e].scale=t.calc.scale,s[e].domain=[1,o],s[e].range=[1,s[e].max_step]);for(let i=0;i<e.length;i++){let a,n=e[i].anchorage.p1,o=e[i].anchorage.p2,l=1;if("Cytoplasmic"===e[i].note&&(l=-1),"simple"===r.type){let _,p=this.makeLoopScaling(s.y_step,t)(e[i].aanum)*r.calc.y_step,c=0;r.calc.hasOwnProperty("x_skew_perc")&&(c=r.calc.x_skew_perc),r.calc.hasOwnProperty("add_wave_fold")&&(_=this.checkWaveFold(e[i],r.calc.add_wave_fold)),a=this.generateSimpleLoopPoints(n,o,p,l,c,_)}else if("swirl"===r.type){let _=this.makeLoopScaling(s.y_step,t)(e[i].aanum)*r.calc.y_step,p=r.calc.swirl_x,c=r.calc.perc_step_y;a=this.generateSwirlLoopPoints(n,o,p,_,c,l)}else if("bulb"===r.type){let _,p=this.makeLoopScaling(s.y_step,t)(e[i].aanum)*r.calc.y_step,c=this.makeLoopScaling(s.x_step,t)(e[i].aanum)*r.calc.x_step,d=r.calc.perc_step_y;r.calc.hasOwnProperty("add_wave_fold")&&(_=this.checkWaveFold(e[i],r.calc.add_wave_fold));let h=0;r.calc.hasOwnProperty("x_skew_perc")&&(h=r.calc.x_skew_perc),a=this.generateBulbLoopPoints(n,o,c,p,d,l,h,_)}else if("mushroom"===r.type){let _,p=this.makeLoopScaling(s.y_step,t)(e[i].aanum)*r.calc.y_step,c=this.makeLoopScaling(s.x_step,t)(e[i].aanum)*r.calc.x_step,d=r.calc.perc_step_y1,h=r.calc.perc_step_y2,u=r.calc.perc_center_x;r.calc.hasOwnProperty("add_wave_fold")&&(_=this.checkWaveFold(e[i],r.calc.add_wave_fold));let m=0;r.calc.hasOwnProperty("x_skew_perc")&&(m=r.calc.x_skew_perc),a=this.generateMushRoomLoopPoints(n,o,c,p,u,d,h,l,m,_)}e[i].points=a}return e}generatePathWithLength(e,t,r,i,a,n,o,s){let l,_,p=1,c=0;for(o.hasOwnProperty("x_skew_perc")&&(_=this.deepCopy(o.x_skew_perc));r>c;){if("simple"===n){let r,n=p*o.y_step,_=0;a.calc.hasOwnProperty("x_skew_perc")&&(_=a.calc.x_skew_perc),a.calc.hasOwnProperty("add_wave_fold")&&(r=this.checkWaveFold(s,a.calc.add_wave_fold)),l=this.generateSimpleLoopPoints(e,t,n,i,_,r)}else if("swirl"===n){let r=p*o.y_step,a=o.swirl_x,n=o.perc_step_y;l=this.generateSwirlLoopPoints(e,t,a,r,n,i)}else if("simple_skewed"===n){let r=p*o.y_step,a=o.perc_center_x;l=this.generateSkewedSimpleLoopPoints(e,t,a,r,i)}else if("bulb"===n){let r,n=p*o.y_step,c=p*o.x_step,d=o.perc_step_y;a.calc.hasOwnProperty("add_wave_fold")&&(r=this.checkWaveFold(s,a.calc.add_wave_fold)),l=this.generateBulbLoopPoints(e,t,c,n,d,i,_,r)}else if("mushroom"===n){let r,n=p*o.y_step,c=p*o.x_step,d=o.perc_center_x,h=o.perc_step_y1,u=o.perc_step_y2;a.calc.hasOwnProperty("add_wave_fold")&&(r=this.checkWaveFold(s,a.calc.add_wave_fold)),l=this.generateMushRoomLoopPoints(e,t,c,n,d,h,u,i,_,r)}else if("n_curves"===n){let r=p*o.y_step,n=a.calc.perc_centers_height,s=n.length,_=a.calc.loop_rotation;l=this.generateNWaveCurves(e,t,s,r,n,i,_)}if(this.checkForNaN(l)||0===l.length)return 1===p?[e,t]:void 0;c=this.getGhostPathLength(l),p+=1}return l}calculateResLengthPointData(e,t,r){let i=e.map(function(e,t){return[e.anchorage.dist,t,e.aanum]}).sort(function(e,t){return e[0]-t[0]}),a=i[0][0],n=(i[0][1],a/i[0][2]),o=t.calc.length;o<n&&(console.log("WARNING: Reslength is smaller than what is possible. Refactoring..."),o=n,t.calc.length=n);let s={};for(const e in r.calc)r.calc.hasOwnProperty(e)&&(s[e]=r.calc[e]);for(let t=0;t<e.length;t++){let i=e[t].anchorage.p1,a=e[t].anchorage.p2,n=1;"Cytoplasmic"===e[t].note&&(n=-1),"n_curves"===r.type&&(n=!0);let l=e[t].aanum*o,_=this.generatePathWithLength(i,a,l,n,r,r.type,s,e[t]);e[t].points=_}return e}calculateCustomPointData(e,t,r){for(let i=0;i<e.length;i++){let a,n,o,s=e[i].anchorage.p1,l=e[i].anchorage.p2,_=1;if("Cytoplasmic"===e[i].note&&(_=-1),e[i].hasOwnProperty("dom_name")){let r=e[i].dom_name,o=e[i].dom_itype;a=t.calc.width[r][o]*this.svg_width,n=t.calc.height[r][o]*this.svg_height}else{let r=e[i].dom_iname;a=t.calc.width[r]*this.svg_width,n=t.calc.height[r]*this.svg_height}if("simple"===r.type){let t,a=0;r.calc.hasOwnProperty("x_skew_perc")&&(a=r.calc.x_skew_perc),r.calc.hasOwnProperty("add_wave_fold")&&(t=this.checkWaveFold(e[i],r.calc.add_wave_fold)),o=this.generateSimpleLoopPoints(s,l,n,_,a,t)}else if("swirl"===r.type){let e=r.calc.swirl_x,t=r.calc.perc_step_y;o=this.generateSwirlLoopPoints(s,l,e,n,t,_)}else if("bulb"===r.type){let t,p=r.calc.perc_step_y;r.calc.hasOwnProperty("add_wave_fold")&&(t=this.checkWaveFold(e[i],r.calc.add_wave_fold));let c=0;r.calc.hasOwnProperty("x_skew_perc")&&(c=r.calc.x_skew_perc),o=this.generateBulbLoopPoints(s,l,a,n,p,_,c,t)}else if("mushroom"===r.type){let t,p=r.calc.perc_step_y1,c=r.calc.perc_step_y2,d=r.calc.perc_center_x;r.calc.hasOwnProperty("add_wave_fold")&&(t=this.checkWaveFold(e[i],r.calc.add_wave_fold));let h=0;r.calc.hasOwnProperty("x_skew_perc")&&(h=r.calc.x_skew_perc),o=this.generateMushRoomLoopPoints(s,l,a,n,d,p,c,_,h,t)}e[i].points=o}return e}gen_centroids_loop_paths_resids(e){let t=document.getElementsByClassName(e);for(let e=0;e<t.length;e++){const r=t[e];let i=r.getBBox(),a=i.x+i.width/2,n=i.y+i.height/2,o=d3.select(r).datum();o.centroid=[a,n],d3.select(r).datum(o)}}draw_loop_paths_resids(e,t,r){let i=r.pathSegmentToXYPoints,a=r.checkFillResidue,n=r.gen_centroids_loop_paths_resids,o=d3.line().curve(d3.curveNatural),s=e.datum(),l="dom_name",_="dom_itype";!1!==s.hasOwnProperty(l)&&s[l]||(l="id",_="id");s.resids;e.append("g").attr("id",function(e){return"g_"+t+"_resids_"+e[l]+"_"+e[_]}).attr("class","g_"+t+"_resids residue_path").style("visibility","hidden").selectAll(+function(e){return"."+t+"_resid_"+e[l]+"_"+e[_]}).data(function(e){let r=e.aas.split(""),a=(e.draw_area.height,r.length,[]),n="g_"+t+"_"+e[l]+"_"+e[_],o=document.getElementById(n).getTotalLength()/e.resids.length,p=0;for(let n=0;n<r.length;n++){r[n];let c=(p=o*n)+o,d=i(document.getElementById("g_"+t+"_"+e[l]+"_"+e[_]),p,c,1);a.push({id:e.id,type:e.type,dom_name:e.dom_name,dom_iname:e.dom_iname,dom_itype:e.dom_itype,path_piece_pts:d,fill:s.fill,stroke:s.stroke,stroke_width:s.stroke_size,opacity:s.opacity,res_1:e.resids[n].res_1,res_3:e.resids[n].res_3,res_ind:e.resids[n].res_ind})}return a}).join(function(e){let i=e.append("path").attr("class",function(e){return t+"_resid_"+e[l]+"_"+e[_]+" "+t+"_residues single_residue_path"}).attr("resname",function(e){return e.res_3+e.res_ind}).attr("d",function(e){return o(e.path_piece_pts)}).attr("stroke-width",function(e){return e.stroke_width}).attr("fill",function(e){return e.fill}).attr("opacity",function(e){let t=a(e,r)[1];return t||e.opacity}).attr("stroke",function(e){let t=a(e,r)[0];return t||e.stroke});return n(t+"_residues"),i},function(e){return e.transition().attr("fill",function(e){return e.fill}).attr("opacity",function(e){let t=a(e,r)[1];return t||e.opacity}).attr("stroke",function(e){let t=a(e,r)[0];return t||e.stroke})})}draw_loop_paths(e,t){let r=this,i=this.draw_loop_paths_resids,a=d3.line().curve(d3.curveNatural);d3.select("#"+this.svg_id).append("g").attr("class",t+"_group").selectAll("."+t).data(e).join(function(e){let n=e.append("g").attr("class",t+" element_path_group").datum(function(e){let i=r.deepCopy(e),a="dom_name",n="dom_itype";!1!==e.hasOwnProperty("dom_name")&&e.dom_name||(a="id",n="id");let o=t+"_"+e[a]+"_"+e[n];return i.path_id_basis=o,i});n.append("g").attr("id",function(e,t){return"g_border_"+e.path_id_basis+"_"+t}).datum(function(e){let t=r.deepCopy(e);return t.clicked=!1,t}).style("visibility","hidden").attr("class","element_path_group_border").selectAll(+function(e,t){return".g_border_"+e.path_id_basis+"_points"}).data(function(e){return e.points}).enter().append("circle").attr("class",function(){return"g_border_"+d3.select(d3.select(this).node().parentNode).datum().path_id_basis+"_points"}).attr("cx",function(e){return e[0]}).attr("cy",function(e){return e[1]}).attr("r",5).attr("fill","green");n.append("path").attr("id",function(e){let r="dom_name",i="dom_itype";return!1!==e.hasOwnProperty("dom_name")&&e.dom_name||(r="id",i="id"),"g_"+t+"_"+e[r]+"_"+e[i]}).attr("class","element_path").attr("d",function(e){return a(e.points)}).attr("stroke",function(e){return e.stroke}).attr("fill",function(e){return e.fill}).attr("opacity",function(e){return e.opacity}).attr("stroke-width",function(e){return e.stroke_size});return n.on("mouseover",function(e,t){let i=d3.select("#g_border_"+e.path_id_basis+"_"+t);!1===r.deepCopy(i.datum()).clicked&&i.style("visibility","hidden")}).on("mouseout",function(e,t){let i=d3.select("#g_border_"+e.path_id_basis+"_"+t);!1===r.deepCopy(i.datum()).clicked&&i.style("visibility","hidden")}),i(n,t,r),n},function(e){return e},function(e){return e.remove()})}draw_shortLoops(e){let t=this.style_obj.protein.short_loops_draw_opts.calc_len,r=this.style_obj.protein.short_loops_draw_opts.shape;"fixed"===t.type?e=this.calculateFixedPointData(e,t,r):"scaled"===t.type?e=this.calculateScaledPointData(e,t,r):"reslen"===t.type?e=this.calculateResLengthPointData(e,t,r):"custom"===t.type&&(e=this.calculateCustomPointData(e,t,r)),this.draw_loop_paths(e,"short_loops")}calculateFixedCustomPointDataPore(e,t,r){for(let i=0;i<e.length;i++){let a,n,o=e[i].dom_name,s=e[i].dom_itype,l=e[i].anchorage.p1,_=e[i].anchorage.p2,p=-1,c=e[i].draw_area.height;a=t.calc.height.constructor==Object?t.calc.height[o][s]*c:t.calc.height*c;let d=r.calc.perc_center_x;n=this.generateSkewedSimpleLoopPoints(l,_,d,a,p),e[i].points=n}return e}calculateScaledPointDataPore(e,t,r){let i=e.map(function(e,t){return[e.aanum,t,e.draw_area.height]}).sort(function(e,t){return t[0]-e[0]}),a=i[0][0],n=i[0][2]*t.calc.height,o={y_step:{}};o.y_step.max_step=n/r.calc.y_step,o.y_step.scale=t.calc.scale,o.y_step.domain=[1,a],o.y_step.range=[1,n/r.calc.y_step];let s=this.makeLoopScaling(o.y_step,t);for(let t=0;t<e.length;t++){let i,a=e[t].anchorage.p1,n=e[t].anchorage.p2,o=-1,l=s(e[t].aanum)*r.calc.y_step,_=r.calc.perc_center_x;i=this.generateSkewedSimpleLoopPoints(a,n,_,l,o),e[t].points=i}return e}calculateResLengthPointDataPore(e,t,r){let i=e.map(function(e,t){return[e.anchorage.dist,t,e.aanum]}).sort(function(e,t){return e[0]-t[0]}),a=i[0][0],n=(i[0][1],a/i[0][2]),o=t.calc.length;o<n&&(console.log("WARNING: Reslength is smaller than what is possible. Refactoring..."),o=n,t.calc.length=n);let s={};for(const e in r.calc)r.calc.hasOwnProperty(e)&&(s[e]=r.calc[e]);for(let t=0;t<e.length;t++){let i=e[t].anchorage.p1,a=e[t].anchorage.p2,n=-1,l=e[t].aanum*o,_=this.generatePathWithLength(i,a,l,n,r,r.type,s,e[t]);e[t].points=_}return e}draw_poreLoops(e){let t=this.style_obj.protein.pore_loops_draw_opts.calc_len,r=this.style_obj.protein.pore_loops_draw_opts.shape;"fixed"===t.type||"custom"===t.type?e=this.calculateFixedCustomPointDataPore(e,t,r):"scaled"===t.type?e=this.calculateScaledPointDataPore(e,t,r):"reslen"===t.type&&(e=this.calculateResLengthPointDataPore(e,t,r)),this.draw_loop_paths(e,"pore_loops")}draw_longLoops(e){let t=this.style_obj.protein.long_loops_draw_opts.calc_len,r=this.style_obj.protein.long_loops_draw_opts.shape;"fixed"===t.type?e=this.calculateFixedPointData(e,t,r):"scaled"===t.type?e=this.calculateScaledPointData(e,t,r):"reslen"===t.type?e=this.calculateResLengthPointData(e,t,r):"custom"===t.type&&(e=this.calculateCustomPointData(e,t,r)),this.draw_loop_paths(e,"long_loops")}calculateFixedPointTermini(e,t,r){let i,a,n=(i=(e.terminus_type,this.svg_drawarea.end_y-this.svg_drawarea.membrane_end))*t.calc.height,o=e.anchorage.p1,s=e.anchorage.p2;if("n_curves"===r.type){let e=r.calc.perc_centers_height,t=e.length,i=r.calc.loop_rotation;a=this.generateNWaveCurves(o,s,t,n,e,!0,i)}return e.points=a,this.draw_loop_paths([e],e.terminus_type+"ter_loops"),e}draw_termini(e){let t,r;"N"===e.terminus_type?(t=this.style_obj.protein.nter_loop_draw_opts.calc_len,r=this.style_obj.protein.nter_loop_draw_opts.shape):(t=this.style_obj.protein.cter_loop_draw_opts.calc_len,r=this.style_obj.protein.cter_loop_draw_opts.shape),"fixed"===t.type?e=this.calculateFixedPointTermini(e,t,r):"reslen"===t.type&&(e=this.calculateResLengthPointData([e],t,r),this.draw_loop_paths(e,e[0].terminus_type+"ter_loops"))}draw_residue_relations(e,t,r){let i,a=this,n=this.style_obj.protein.residue_relations_draw_opts;"calc"===n.path_width_scaling.type&&(i=n.path_width_scaling.group_by_type),e=this.mergeDrawData("residue_relations",this.deepCopy(e),this);let o=[],s={};i&&(o=e.map(function(e){return s[e.type]=0,e.type}),o=this.deepCopy(o).filter(this.onlyUnique));let l=e.reduce(function(e,t){return e+t.raw_weight},0);if(i)for(let t=0;t<e.length;t++)s[e[t].type]+=e[t].raw_weight;let _=[],p=[],c={},d={};for(let t=0;t<e.length;t++)e[t].absolute_weight=e[t].raw_weight,i?(e[t].relative_weight=e[t].raw_weight/s[e[t].type],!1===c.hasOwnProperty(e[t].type)&&(c[e[t].type]=[]),c[e[t].type].push(e[t].relative_weight),!1===d.hasOwnProperty(e[t].type)&&(d[e[t].type]=[]),d[e[t].type].push(e[t].absolute_weight)):e[t].relative_weight=e[t].raw_weight/l,p.push(e[t].absolute_weight),_.push(e[t].relative_weight);let h,u,m,y=this.deepCopy(_),g=this.deepCopy(c);if("absolute"===n.weight_scaling&&(y=p,g=this.deepCopy(d)),"calc"===n.path_width_scaling.type){let e=n.path_width_scaling.domain,t=n.path_width_scaling.range;if(i){let r=this.deepCopy;h=function(i,a){let n=r(e);"min"===n[0]&&(n[0]=d3.min(g[a])),"max"===n[1]&&(n[1]=d3.max(g[a]));let o=r(t);return d3.scaleLinear().domain(n).range(o)(i)}}else"min"===e[0]&&(e[0]=d3.min(y)),"max"===e[1]&&(e[1]=d3.max(y)),h=d3.scaleLinear().domain(e).range(t)}else h="fixed"===n.path_width_scaling.type?function(e){return a.svg_width*n.path_width_scaling.perc_x}:function(e){return 0};let f,w=n.color_scaling.lighter_fill;if(console.log("draw_opts.color_scaling"),console.log(n.color_scaling),"weight"===n.color_scaling.type){if("weight"===n.color_scaling.property){n.color_scaling.domain||(n.color_scaling.domain=["min","max"]),n.color_scaling.range||(n.color_scaling.range=["lightblue","blue"]),m=n.weight_scaling+"_"+n.color_scaling.property;let e=n.color_scaling.domain;"min"===e[0]&&(e[0]=d3.min(y)),"max"===e[1]&&(e[1]=d3.max(y));let t=n.color_scaling.range;u=d3.scaleLinear().domain(e).range(t)}else if("type"===n.color_scaling.property){m=n.color_scaling.property;let e=n.color_scaling.domain,t=n.color_scaling.range;u=function(r){return t[e.indexOf(r)]}}}else if("type"===n.color_scaling.type){m=n.color_scaling.type;let e=n.color_scaling.domain,t=n.color_scaling.range;u=function(r){return t[e.indexOf(r)]}}"fixed"===n.element_centroid_scaling.type&&(f=n.element_centroid_scaling.radius);let x=[];for(let a=0;a<e.length;a++){let o=e[a];console.log("raw_relation"),console.log(o);let s,l=o.source,_=o.target,p=this.whereIsResIdElName(l,r),c=this.whereIsResIdElName(_,r),d=t[l].point,y=t[_].point,g=[],f=[],b=e[a].relative_weight;"absolute"===n.weight_scaling&&(b=e[a].absolute_weight),s=i?h(b,e[a].type):h(b);let v=this.calculateDotArrayMiddlePoint(d,y);if("fixed"===n.centroid_pos.type){if(console.log("calc centroid fixed"),console.log("draw_opts.centroid_pos"),console.log(n.centroid_pos),"between"!==n.centroid_pos.perc_y){let e=this.svg_height*n.centroid_pos.perc_y;v[1]=e}if("between"!==n.centroid_pos.perc_x){let e=this.svg_width*n.centroid_pos.perc_x;v[0]=e}console.log("mid_point"),console.log(v)}else{console.log("calc centroid custom");let e="extracellular";"helix"===p.type||"pore"===p.type?e="intramembrane":"loop"===p.type&&p.draw_area.start_y>this.svg_height/2&&(e="intracellular");let t="extracellular";"helix"===c.type||"pore"===c.type?t="intramembrane":"loop"===c.type&&c.draw_area.start_y>this.svg_height/2&&(t="intracellular");let r=n.centroid_pos.perc_dict[e][t];if("between"!==r.perc_y1){let e=this.svg_height*r.perc_y1;v[1]=e}if("between"!==r.perc_x1){let e=this.svg_width*r.perc_x1;v[0]=e}g=[v]}if(s>0){console.log("centroid_height");let e=this.createVector(d,y),t=this.normalizeVector(e),r=this.scaleVector(t,s),i=this.rotateByAng(r,v,90),a=this.rotateByAng(r,v,-90);g=[i],f=[a]}let k=[];k.push(d),k.push(...g),k.push(y),f.length>0&&(k.push(...f),k.push(d)),k=(k=k.filter(function(e){return!1===isNaN(e[0])&&!1===isNaN(e[1])})).filter(function(e){return null!==e[0]&&null!==e[1]});for(let e=0;e<k.length;e++){let t="blue";x.push({point:k[e],fill:t,stroke:"yellow",stroke_size:"1px",opacity:"1",circle_radius:"4px"})}if(e[a].source_resid=o.source,e[a].target_resid=o.target,e[a].points=this.deepCopy(k),u){let t=u(e[a][m]);w&&(t="rgba("+this.colorToRGBA(t)+")",t=this.pSBC(.2,t)),e[a].fill=t,e[a].stroke=u(e[a][m])}}this.draw_relation_paths(e)}whereIsResIdElName(e,t){let r,i=e+"",a=["Domain","InterDomain"],n=this.deepCopy;if(!1===i.includes(a[0])&&!1===i.includes(a[1])){let i=this.convertToResInd(e)[0];r=n(t).filter(function(e){return e.start<=i&&e.end>=i})}else if(!0===i.includes(a[1])){let i=parseInt(e.split("InterDomain")[1].split(";")[0]);r=n(t).filter(function(e){return e.dom_iname===i})}else if(!0===i.includes(a[0])){let i=e.split("Domain")[1].split(";")[0],a=e.split(";")[1];if("Pore"===a)a=a.toLowerCase(),r=n(t).filter(function(e){return e.dom_name===i&&e.type===a});else{let e=parseInt(a.split("")[a.length-1]);a=(a=a.slice(0,a.length-1)).toLowerCase(),r=n(t).filter(function(t){return t.dom_name===i&&t.type===a&&t.dom_itype===e})}}return r[0]}draw_relation_paths(e){let t=d3.line().curve(d3.curveCatmullRom);d3.select("#"+this.svg_id).append("g").attr("class","relations_group").selectAll(".relation_paths_g").data(e).join(function(e){let r=e.append("g").attr("class","relation_paths_g");r.append("path").attr("id",function(e){return e.source_resid+"_"+e.target_resid}).attr("class","relation_path").attr("d",function(e){return t(e.points)}).attr("stroke",function(e){return e.stroke}).attr("fill",function(e){return e.fill}).attr("opacity",function(e){return e.opacity}).attr("stroke-width",function(e){return e.stroke_size});return r},function(e){return e},function(e){return e.remove()})}draw_symbols(e,t,r,i){for(let a=0;a<e.length;a++){!1===e[a].hasOwnProperty("font_family")&&(e[a].font_family=this.style_obj.text_defs.font_family),!1===e[a].hasOwnProperty("font_style")&&(e[a].font_style=this.style_obj.text_defs.font_style),!1===e[a].hasOwnProperty("font_size")&&(e[a].font_size=this.style_obj.text_defs.font_size),!1===e[a].hasOwnProperty("fill")&&(e[a].fill=this.style_obj.text_defs.fill);let n=this.getBBoxGhostText(e[a]);if("absolute"===e[a].positioning.type)e[a].tdx=e[a].positioning.x,e[a].tdy=e[a].positioning.y,e[a].x=e[a].positioning.x,e[a].y=e[a].positioning.y;else if("residue_or_element"===e[a].positioning.type){let r=this.convertToResInd(e[a].positioning.reference),i=t[r=r[0]].point;e[a].tdx=i[0],e[a].tdy=i[1],e[a].x=i[0],e[a].y=i[1]}else e[a].positioning.type;this.style_obj.text_defs.center_xy&&(e[a].tdx-=n.width/2,e[a].tdy-=n.height/2,e[a].x-=n.width/2,e[a].y-=n.height/2),!0===e[a].positioning.hasOwnProperty("dx")&&(e[a].tdx+=e[a].positioning.dx,e[a].x+=e[a].positioning.dx),!0===e[a].positioning.hasOwnProperty("dy")&&(e[a].tdy+=e[a].positioning.dy,e[a].y+=e[a].positioning.dy);let o={start_x:e[a].x,start_y:e[a].y,centroid:[e[a].x+n.width/2,e[a].y+n.height/2],end_x:e[a].x+n.width,end_y:e[a].y+n.height,width:n.width,height:n.height};if(console.log("symbols_data"),console.log(e),!1===e[a].hasOwnProperty("text")&&!0===e[a].hasOwnProperty("props")&&"residue_relation"!==e[a].positioning.type){let n="",o=this.convertToResInd(e[a].positioning.reference);o=o[0];let s=this.whereIsResIdElName(e[a].positioning.reference,i),l=Object.keys(s),_=Object.keys(t[o]),p=[];r.hasOwnProperty(o)&&(p=Object.keys(r[o]));for(let i=0;i<e[a].props.length;i++){let c=e[a].props[i];l.indexOf(c)>-1?n+=s[c]:_.indexOf(c)>-1?n+=t[o][c]:p.indexOf(c)>-1?n+=r[o][c]:n+=c}e[a].text=n}e[a].draw_area=o}return this.draw_text_symbols(e),e}draw_text_symbols(e){let t=this;function r(e){let r=d3.select("#text_symbol_"+e),i=(d3.select("#text_symbol_border_"+e).attr("x",function(){return r.node().getBBox().x}).attr("y",function(){return r.node().getBBox().y}).attr("height",function(){return r.node().getBBox().height}).attr("width",function(){return r.node().getBBox().width}),d3.select("#naview_text_editor_div"));i.size()>0&&i.style("left",function(){let r=d3.select("#text_symbol_"+e);return r.node().getBBox().x+r.node().getBBox().width+15+t.scrollX+"px"}).style("top",function(){let r=d3.select("#text_symbol_"+e),i=t.scrollY;return r.node().getBBox().y+5+i+"px"})}function i(e,r,i){let a=d3.select("#text_symbol_"+e).datum();r instanceof Array?"positioning"===r[0]&&(a.positioning.type="absolute",a.positioning[r[1]]=i[0],a.positioning[r[2]]=i[1],t.parsed_protein_data.draw_symbols[e].positioning.type="absolute",t.parsed_protein_data.draw_symbols[e].positioning[r[1]]=i[0],t.parsed_protein_data.draw_symbols[e].positioning[r[2]]=i[1]):(a[r]=i,t.parsed_protein_data.draw_symbols[e][r]=i)}var a=d3.drag().on("drag",function(e,t){let a=d3.select(this);d3.select("#text_symbol_border_"+t);var n=d3.mouse(this),o=n[0],s=n[1];a.attr("x",o).attr("y",s),r(t),i(t,["positioning","x","y"],[o,s])});d3.select("#"+this.svg_id).append("g").attr("class","text_symbols_group").selectAll(".text_symbols_g").data(e).join(function(e){let n=e.append("g").attr("id",function(e,t){return"text_symbols_g_"+t}).attr("class","text_symbols_g").style("cursor","pointer").datum(function(e,r){let i=t.deepCopy(e);return i.ind_el=r,i}),o=n.append("rect").attr("class","text_symbol_borders").attr("id",function(e,t){return"text_symbol_border_"+t}).attr("fill","transparent").attr("stroke","black").attr("stroke-size","2px").style("visibility","hidden").datum(function(e){let r=t.deepCopy(e);return r.clicked=!1,r}).attr("width",function(e){return e.draw_area.width}).attr("height",function(e){return e.draw_area.height}),s=n.append("text").attr("id",function(e,t){return"text_symbol_"+t}).attr("class","text_symbols_el").attr("fill",function(e){return e.fill}).attr("font-style",function(e){return e.font_style}).attr("font-family",function(e){return e.font_family}).attr("font-size",function(e){return e.font_size}).text(function(e){return e.text}).attr("x",function(e){return e.draw_area.start_x}).attr("y",function(e){return e.draw_area.start_y});return a(s),o.attr("x",function(e,t){return d3.select("#text_symbol_"+t).node().getBBox().x}).attr("y",function(e,t){return d3.select("#text_symbol_"+t).node().getBBox().y}),n.on("mouseover",function(e,r){let i=d3.select("#text_symbol_border_"+r);!1===t.deepCopy(i.datum()).clicked&&d3.select("#text_symbol_border_"+r).style("visibility","")}).on("mouseout",function(e,r){let i=d3.select("#text_symbol_border_"+r);!1===t.deepCopy(i.datum()).clicked&&d3.select("#text_symbol_border_"+r).style("visibility","hidden")}).on("click",function(e,a){if(d3.event.defaultPrevented)return;let n=d3.select("#text_symbol_border_"+a);d3.selectAll(".text_symbol_borders").style("visibility","hidden"),d3.selectAll(".text_symbol_borders").datum(function(e,r){let i=t.deepCopy(e);return r!==a&&(i.clicked=!1),i}),function(){let e=d3.select("#naview_text_editor_div");e.size()>0&&e.remove()}();let o=t.deepCopy(n.datum());!1===o.clicked&&(d3.select("#text_symbol_border_"+a).style("visibility",""),function(e,a){let n=d3.select("#naview_text_editor_div");n.size()>0&&n.remove(),(n=d3.select("body").append("div").attr("id","naview_text_editor_div").style("position","absolute").style("text-align","center").style("background","white").style("z-index",4).style("max-height",function(){return d3.select("#"+t.svg_id).node().getBBox().height/3+"px"}).style("font-family","monospace").style("overflow-y","scroll").style("border","black 1px solid").style("left",function(){let e=d3.select("#text_symbol_"+a);return e.node().getBBox().x+e.node().getBBox().width+15+t.scrollX+"px"}).style("top",function(){let e=d3.select("#text_symbol_"+a),r=t.scrollY;return e.node().getBBox().y+5+r+"px"})).append("h4").html("Text Editor:"),n.append("p").html("Text:"),n.append("input").attr("type","text").attr("size","5").attr("value",function(){return e.text}).on("change",function(){let e=d3.select(this).property("value");d3.select("#text_symbol_"+a).text(e),r(a),i(a,"text",e)}),n.append("p").html("Font Family:"),n.append("input").attr("type","text").attr("value",function(){return e.font_family}).on("change",function(){let e=d3.select(this).property("value");d3.select("#text_symbol_"+a).attr("font-family",e),r(a),i(a,"font_family",e)}),n.append("p").html("Font Size:"),n.append("input").attr("type","number").attr("value",function(){return parseFloat(e.font_size)}).attr("step",1).on("change",function(){let e=d3.select(this).property("value");d3.select("#text_symbol_"+a).attr("font-size",e),r(a),i(a,"font_size",e)}),n.append("p").html("Font Style:");let o=n.append("select").on("change",function(){let e=d3.select(this).property("value");d3.select("#text_symbol_"+a).attr("font-style",e),r(a),i(a,"font_style",e)});o.append("option").attr("value","normal").html("Normal").property("selected",function(){return"normal"===d3.select("#text_symbol_"+a).attr("font-style")}),o.append("option").attr("value","italic").html("Italic").property("selected",function(){return"italic"===d3.select("#text_symbol_"+a).attr("font-style")}),n.append("p").html("Font Color:"),n.append("input").attr("type","color").attr("value",function(){let r=e.fill;return r=t.colorToRGB(r),r=t.rgbToHex(r[0],r[1],r[2])}).on("change",function(){let e=d3.select(this).property("value");d3.select("#text_symbol_"+a).attr("fill",e),r(a),i(a,"fill",e)}),n.append("br"),n.append("br"),n.append("button").html("Remove Text").on("click",function(){d3.select("#text_symbols_g_"+a).remove(),t.parsed_protein_data.draw_symbols.splice(a,1),d3.select("#naview_text_editor_div").remove()})}(e,a)),o.clicked=!o.clicked,n.datum(o)}),n},function(e){return e},function(e){return e.remove()})}getBBoxGhostText(e,t){let r=d3.select("#"+this.svg_id).append("g").attr("id",function(){if(t)return"par"+t}).attr("visibility","hidden"),i=r.append("text").attr("id",function(){if(t)return t}).attr("fill",function(){return e.fill}).attr("font-style",function(){return e.font_style}).attr("font-family",function(){return e.font_family}).attr("font-size",function(){return e.font_size}).text(function(){return e.text}).node().getBBox();return t||r.remove(),i}convertToResInd(e){let t=e+"";if(/\d+/.test(e)&&!1===t.includes(";")){let e=t.match(/\d+/)[0];return[parseInt(e),!0]}return[e,!1]}}